var app=angular.module("anyArchitect",["ngCookies","angularjs-dropdown-multiselect","ui.bootstrap","ui.select","ngSanitize"]);app.service("GMapService",function(){this.gmap={};var i=this,e=document.getElementById("map-canvas");function t(e){this.tileSize=e}function o(e){this.tileSize=e}t.prototype.maxZoom=22,t.prototype.name="OSM",t.prototype.alt="Tile OSM Map Type",t.prototype.getTile=function(e,t,o){if(19<t)return null;var i=1<<t,n=e.x%i;n<0&&(n=i+n);var a=o.createElement("img");return a.src="https://tile.openstreetmap.org/"+t+"/"+n+"/"+e.y+".png",a.style.width=this.tileSize.width+"px",a.style.height=this.tileSize.height+"px",a},o.prototype.maxZoom=22,o.prototype.name="Carto Light",o.prototype.alt="Tile Carto Light Map Type",o.prototype.getTile=function(e,t,o){var i="https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png";i=i.replace("{x}",e.x).replace("{y}",e.y).replace("{z}",t);var n=o.createElement("img");return n.src=i,n.style.width=this.tileSize.width+"px",n.style.height=this.tileSize.height+"px",n};var n=DEFAULT_MAP_TILES;function a(e){var t="custom-maps-attribution",o=document.getElementById(t);null==o&&((o=document.createElement("div")).id=t,e.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push(o)),"OSM"===i.gmap.getMapTypeId()&&(o.innerHTML='<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'),"roadmap"===i.gmap.getMapTypeId()&&(o.innerHTML=""),"satellite"===i.gmap.getMapTypeId()&&(o.innerHTML=""),"CartoLight"===i.gmap.getMapTypeId()&&(o.innerHTML='<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Â© <a href="https://carto.com/attribution">CARTO</a>')}"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("mapTypeId",DEFAULT_MAP_TILES),i.gmap=new google.maps.Map(e,{center:new google.maps.LatLng(57,21),zoomControl:!0,fullscreenControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.LEFT_CENTER},scaleControl:!0,streetViewControl:!1,overviewMapControl:!0,zoom:3,mapTypeId:n,mapTypeControlOptions:{mapTypeIds:["OSM","CartoLight","roadmap","satellite"],style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.LEFT_CENTER}}),i.gmap.addListener("maptypeid_changed",function(){localStorage.setItem("mapTypeId",i.gmap.getMapTypeId()),a(i.gmap)}),i.gmap.mapTypes.set("OSM",new t(new google.maps.Size(256,256))),i.gmap.mapTypes.set("CartoLight",new o(new google.maps.Size(256,256))),a(i.gmap);var r=document.getElementById("pac-input");i.gmap.controls[google.maps.ControlPosition.TOP_LEFT].push(r),i.searchBox=new google.maps.places.SearchBox(r),google.maps.event.addListener(i.gmap,"tilesloaded",function(){$(".dismissButton").click(),google.maps.event.addListener(i.gmap,"tilesloaded",function(){$("#pac-input").fadeIn(500)})}),google.maps.event.addListener(i.searchBox,"places_changed",function(){var e=i.searchBox.getPlaces();0!=e.length&&(i.gmap.panTo(e[0].geometry.location),i.gmap.setZoom(17))}),i.gmap.addListener(i.gmap,"bounds_changed",function(){var e=i.gmap.getBounds();i.searchBox.setBounds(e)})}),app.factory("AnyplaceService",function(){var e={selectedBuilding:void 0,selectedFloor:void 0,selectedPoi:void 0,selectedCampus:void 0,ShowShareProp:void 0,progress:void 0,allPois:{},allConnections:{},radioHeatmapRSSMode:!1,radioHeatmapLocalization:!1,fingerPrintsTimeMode:!1,radioHeatmapRSSTimeMode:!1,alerts:[],jsonReq:{username:"username",password:"password"},BASE_URL:"https://ap.cs.ucy.ac.cy",getBuilding:function(){return this.selectedBuilding},getCampus:function(){return this.selectedCampus},getBuildingId:function(){if(this.selectedBuilding)return this.selectedBuilding.buid},getBuildingName:function(){return this.selectedBuilding?this.selectedBuilding.name:"N/A"},getCampusName:function(){return this.selectedCampus?this.selectedCampus.name:"N/A"},getFloor:function(){return this.selectedFloor},getFloorNumber:function(){return this.selectedFloor?String(this.selectedFloor.floor_number):"N/A"},getFloorName:function(){return this.selectedFloor.floor_name},setBuilding:function(e){this.selectedBuilding=e},setFloor:function(e){this.selectedFloor=e},addAlert:function(e,t){this.alerts[0]={msg:t,type:e}},closeAlert:function(e){this.alerts.splice(e,1)},getBuildingViewerUrl:function(){return this.selectedBuilding&&this.selectedBuilding.buid?this.selectedBuilding.buid:"N/A"},getBuildingViewerUrlEncoded:function(){return this.selectedBuilding&&this.selectedBuilding.buid?encodeURIComponent("https://ap.cs.ucy.ac.cy/viewer/?buid="+this.selectedBuilding.buid):"N/A"},getCampusViewerUrl:function(){return this.selectedCampus&&this.selectedCampus.cuid?"https://ap.cs.ucy.ac.cy/viewer/?cuid="+this.selectedCampus.cuid:"N/A"},getCampusViewerUrlEncoded:function(){return this.selectedCampus&&this.selectedCampus.cuid?encodeURIComponent("https://ap.cs.ucy.ac.cy/viewer/?cuid="+this.selectedCampus.cuid):"N/A"},setAllPois:function(e){this.allPois={},this.allPois=e},setAllConnection:function(e){this.allConnections={},this.allConnections=e},getAllPois:function(){return this.allPois?this.allPois:"N/A"},getAllConnections:function(){return this.allConnections?this.allConnections:"N/A"},clearAllData:function(){e.selectedPoi=void 0,e.selectedFloor=void 0,e.selectedBuilding=void 0,e.selectedCampus=void 0,e.ShowShareProp=void 0,e.allPois={},e.allConnections={}}};return e}),app.factory("Alerter",function(){var e={AlertCtrl:"-"};return e}),app.factory("formDataObject",function(){return function(e,t){var o=new FormData;return angular.forEach(e,function(e,t){o.append(t,e)}),delete t()["Content-Type"],o}}),app.config(["$locationProvider",function(e){e.html5Mode(!0)}]),app.filter("propsFilter",function(){return function(e,a){var r=[];if(angular.isArray(e)){for(var l=Object.keys(a),s={},t=0;t<l.length;t++){var o=l[t],i=a[o].toLowerCase();s[a[o]]=i}e.forEach(function(e){for(var t=!1,o=0;o<l.length;o++){var i=l[o],n=s[a[i]];if(null!=i&&null!=e[i]&&-1!==e[i].toString().toLowerCase().indexOf(n)){t=!0;break}}t&&r.push(e)})}else r=e;return r}}),app.factory("requestInterceptor",[function(){return{request:function(e){if(void 0!==e.url){var t=null!=app.user;(e.url.startsWith(API.url+"/auth/")||e.url.startsWith(API.old))&&(t||LOG.E("ERROR: user not logged in and requested: "+e.url),t&&(e.headers.access_token=app.user.access_token),e.data&&t&&(e.data.access_token=app.user.access_token))}return e}}}]),app.config(["$httpProvider",function(e){e.interceptors.push("requestInterceptor")}]);var API={old:"../anyplace",url:"../api"};API.VERSION=API.url+"/version",API.Mapping={},API.Navigation={},API.Other={},API.Mapping.APs="/wifi/access_points/floor",API.Mapping.APs_URL=API.url+API.Mapping.APs,API.Mapping.GET_APS_IDS="/wifi/access_points/ids",API.Mapping.GET_APS_IDS_URL=API.url+API.Mapping.GET_APS_IDS,API.Mapping.FINGERPRINTS_DELETE="/auth/radiomap/delete",API.Mapping.FINGERPRINTS_DELETE_URL=API.url+API.Mapping.FINGERPRINTS_DELETE,API.Mapping.FINGERPRINTS_DELETE_TIME="/auth/radiomap/delete/time",API.Mapping.FINGERPRINTS_DELETE_TIME_URL=API.url+API.Mapping.FINGERPRINTS_DELETE_TIME,API.Mapping.FINGERPRINTS_TIME="/radiomap/time",API.Mapping.FINGERPRINTS_TIME_URL=API.url+API.Mapping.FINGERPRINTS_TIME,API.Mapping.RADIO_HEATMAP_RSS_1="/heatmap/floor/average/1",API.Mapping.RADIO_HEATMAP_RSS_URL_1=API.url+API.Mapping.RADIO_HEATMAP_RSS_1,API.Mapping.RADIO_HEATMAP_RSS_2="/heatmap/floor/average/2",API.Mapping.RADIO_HEATMAP_RSS_URL_2=API.url+API.Mapping.RADIO_HEATMAP_RSS_2,API.Mapping.RADIO_HEATMAP_RSS_3="/heatmap/floor/average/3",API.Mapping.RADIO_HEATMAP_RSS_URL_3=API.url+API.Mapping.RADIO_HEATMAP_RSS_3,API.Mapping.RADIO_HEATMAP_RSS_3_TILES="/heatmap/floor/average/3/tiles",API.Mapping.RADIO_HEATMAP_RSS_URL_3_TILES=API.url+API.Mapping.RADIO_HEATMAP_RSS_3_TILES,API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_1="/heatmap/floor/average/timestamp/1",API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_URL_1=API.url+API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_1,API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_2="/heatmap/floor/average/timestamp/2",API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_URL_2=API.url+API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_2,API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_3="/heatmap/floor/average/timestamp/3",API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_URL_3=API.url+API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_3,API.Mapping.RADIO_HEATMAP_BY_TIME_TILES="/heatmap/floor/average/timestamp/tiles",API.Mapping.RADIO_HEATMAP_BY_TIME_TILES_URL=API.url+API.Mapping.RADIO_HEATMAP_BY_TIME_TILES,API.Mapping.RADIOMAP_DELETE="/position/radio/heatmap_building_floor_delete",API.Mapping.RADIOMAP_DELETE_URL=API.old+API.Mapping.RADIOMAP_DELETE,API.Mapping.RADIO_HEATMAP_POI="/mapping/radio/radio_heatmap_bbox",API.Mapping.RADIO_HEATMAP_URL_POI=API.old+API.Mapping.RADIO_HEATMAP_POI,API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL="/radiomap/floor/all",API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL_URL=API.url+API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL,API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL_TXT="/position/radio_by_building_floor_all_text",API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL_TXT_URL=API.old+API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL_TXT,API.Mapping.BUILDING_ADD="/auth/mapping/space/add",API.Mapping.BUILDING_ADD_URL=API.url+API.Mapping.BUILDING_ADD,API.Mapping.BUILDING_ONE="/mapping/space/get",API.Mapping.BUILDING_ONE_URL=API.url+API.Mapping.BUILDING_ONE,API.Mapping.BUILDING_UPDATE="/auth/mapping/space/update",API.Mapping.BUILDING_UPDATE_URL=API.url+API.Mapping.BUILDING_UPDATE,API.Mapping.BUILDING_DELETE="/auth/mapping/space/delete",API.Mapping.BUILDING_DELETE_URL=API.url+API.Mapping.BUILDING_DELETE,API.Mapping.BUILDING_ALL="/mapping/space/public",API.Mapping.BUILDING_ALL_URL=API.url+API.Mapping.BUILDING_ALL,API.Mapping.BUILDING_ALL_OWNER="/auth/mapping/space/accessible",API.Mapping.BUILDING_ALL_OWNER_URL=API.url+API.Mapping.BUILDING_ALL_OWNER,API.Mapping.CAMPUS_ALL="/auth/mapping/campus/user",API.Mapping.CAMPUS_ALL_URL=API.url+API.Mapping.CAMPUS_ALL,API.Mapping.CAMPUS_UPDATE="/auth/mapping/campus/update",API.Mapping.CAMPUS_UPDATE_URL=API.url+API.Mapping.CAMPUS_UPDATE,API.Mapping.CAMPUS_DELETE="/auth/mapping/campus/delete",API.Mapping.CAMPUS_DELETE_URL=API.url+API.Mapping.CAMPUS_DELETE,API.Mapping.BUILDINGSET_ADD="/auth/mapping/campus/add",API.Mapping.BUILDINGSET_ADD_URL=API.url+API.Mapping.BUILDINGSET_ADD,API.Mapping.BUILDINGSET_ALL="/mapping/campus/get",API.Mapping.BUILDINGSET_ALL_URL=API.url+API.Mapping.BUILDINGSET_ALL,API.Mapping.FLOOR_ADD="/auth/mapping/floor/add",API.Mapping.FLOOR_ADD_URL=API.url+API.Mapping.FLOOR_ADD,API.Mapping.FLOOR_UPDATE="/auth/mapping/floor/update",API.Mapping.FLOOR_UPDATE_URL=API.url+API.Mapping.FLOOR_UPDATE,API.Mapping.FLOOR_DELETE="/auth/mapping/floor/delete",API.Mapping.FLOOR_DELETE_URL=API.url+API.Mapping.FLOOR_DELETE,API.Mapping.FLOOR_ALL="/mapping/floor/all",API.Mapping.FLOOR_ALL_URL=API.url+API.Mapping.FLOOR_ALL,API.Mapping.FLOOR_PLAN_UPLOAD="/mapping/floor/floorplan/upload",API.Mapping.FLOOR_PLAN_UPLOAD_URL=API.url+API.Mapping.FLOOR_PLAN_UPLOAD,API.Mapping.FLOOR_PLAN_DOWNLOAD="/floorplans64/",API.Mapping.FLOOR_PLAN_DOWNLOAD_URL=API.url+API.Mapping.FLOOR_PLAN_DOWNLOAD,API.Mapping.FLOOR_PLAN_DOWNLOAD_ALL="/floorplans64/all/",API.Mapping.FLOOR_PLAN_DOWNLOAD_URL_ALL=API.url+API.Mapping.FLOOR_PLAN_DOWNLOAD_ALL,API.Mapping.POIS_ADD="/auth/mapping/pois/add",API.Mapping.POIS_ADD_URL=API.url+API.Mapping.POIS_ADD,API.Mapping.POIS_UPDATE="/auth/mapping/pois/update",API.Mapping.POIS_UPDATE_URL=API.url+API.Mapping.POIS_UPDATE,API.Mapping.POIS_DELETE="/auth/mapping/pois/delete",API.Mapping.POIS_DELETE_URL=API.url+API.Mapping.POIS_DELETE,API.Mapping.POIS_ALL_FLOOR="/mapping/pois/floor/all",API.Mapping.POIS_ALL_FLOOR_URL=API.url+API.Mapping.POIS_ALL_FLOOR,API.Mapping.POIS_ALL_BUILDING="/mapping/pois/space/all",API.Mapping.POIS_ALL_BUILDING_URL=API.url+API.Mapping.POIS_ALL_BUILDING,API.Mapping.ALL_POIS="/mapping/pois/search",API.Mapping.ALL_POIS_URL=API.url+API.Mapping.ALL_POIS,API.Mapping.CONNECTION_ADD="/auth/mapping/connection/add",API.Mapping.CONNECTION_ADD_URL=API.url+API.Mapping.CONNECTION_ADD,API.Mapping.CONNECTION_UPDATE="/auth/mapping/connection/update",API.Mapping.CONNECTION_UPDATE_URL=API.old+API.Mapping.CONNECTION_UPDATE,API.Mapping.CONNECTION_DELETE="/mapping/connection/delete",API.Mapping.CONNECTION_DELETE_URL=API.url+API.Mapping.CONNECTION_DELETE,API.Mapping.CONNECTION_ALL_FLOOR="/mapping/connection/floor/all",API.Mapping.CONNECTION_ALL_FLOOR_URL=API.url+API.Mapping.CONNECTION_ALL_FLOOR,API.Mapping.LOGIN_GOOGLE="/user/login/google",API.Mapping.LOGIN_GOOGLE_URL=API.url+API.Mapping.LOGIN_GOOGLE,API.Mapping.LOGIN_LOCAL="/user/login",API.Mapping.LOGIN_LOCAL_URL=API.url+API.Mapping.LOGIN_LOCAL,API.Mapping.LOGIN_REFRESH_LOCAL="/user/refresh",API.Mapping.LOGIN_REFRESH_LOCAL_URL=API.url+API.Mapping.LOGIN_REFRESH_LOCAL,API.Mapping.REGISTER_LOCAL="/user/register",API.Mapping.REGISTER_LOCAL_URL=API.url+"/user/register",API.Navigation.POIS_ROUTE="/navigation/route",API.Navigation.POIS_ROUTE=API.url+API.Navigation.POIS_ROUTE,API.Other.GOOGLE_URL_SHORTNER_URL="https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDLSYNnIC93KfPnMYRL-7xI7yXjOhgulk8",null==app&&LOG.F("api.js must be loaded after app.js in GruntFile)"),app.factory("AnyplaceAPIService",["$http","$q","formDataObject",function(l,e,o){l.defaults.useXDomain=!0,delete l.defaults.headers.common["X-Requested-With"];var t={version:function(e){return l({method:"GET",url:API.VERSION,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSS_1:function(e){return LOG.D2("getRadioHeatmapRSS_1"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_RSS_URL_1,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSS_2:function(e){return LOG.D2("getRadioHeatmapRSS_2"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_RSS_URL_2,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSS_3:function(e){return LOG.D2("getRadioHeatmapRSS_3"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_RSS_URL_3,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSS_3_Tiles:function(e){return LOG.D2("getRadioHeatmapRSS_3_Tiles"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_RSS_URL_3_TILES,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSSByTime_1:function(e){return LOG.D2("getRadioHeatmapRSSByTime_1"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_URL_1,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSSByTime_2:function(e){return LOG.D2("getRadioHeatmapRSSByTime_2"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_URL_2,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSSByTime_3:function(e){return LOG.D2("getRadioHeatmapRSSByTime_3"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_RSS_BY_TIME_URL_3,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapRSSByTime_Tiles:function(e){return LOG.D2("getRadioHeatmapRSSByTime_Tiles"),l({method:"POST",url:API.Mapping.RADIO_HEATMAP_BY_TIME_TILES_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getAPs:function(e){return l({method:"POST",url:API.Mapping.APs_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getAPsIds:function(e){return l({method:"POST",url:API.Mapping.GET_APS_IDS_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deleteFingerprints:function(e){return l({method:"POST",url:API.Mapping.FINGERPRINTS_DELETE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deleteFingerprintsByTime:function(e){return l({method:"POST",url:API.Mapping.FINGERPRINTS_DELETE_TIME_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getFingerprintsTime:function(e){return l({method:"POST",url:API.Mapping.FINGERPRINTS_TIME_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getHeatmapAcces:function(e){return null},retrievePoisByBuilding:function(e){return l({method:"POST",url:API.Mapping.POIS_ALL_BUILDING_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioHeatmapPoi:function(e){return l({method:"POST",url:API.Mapping.RADIO_HEATMAP_URL_POI,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioByBuildingFloorAll:function(e){return l({method:"POST",url:API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getRadioByBuildingFloorTxt:function(e){return l({method:"POST",url:API.Mapping.RADIO_BY_BUILDING_FLOOR_ALL_TXT_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},addBuilding:function(e){return l({method:"POST",url:API.Mapping.BUILDING_ADD_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},addBuildingSet:function(e){return l({method:"POST",url:API.Mapping.BUILDINGSET_ADD_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},updateBuilding:function(e){return l({method:"POST",url:API.Mapping.BUILDING_UPDATE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},updateCampus:function(e){return l({method:"POST",url:API.Mapping.CAMPUS_UPDATE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deleteBuilding:function(e){return l({method:"POST",url:API.Mapping.BUILDING_DELETE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deleteRadiomaps:function(e){return l({method:"POST",url:API.Mapping.RADIOMAP_DELETE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deleteCampus:function(e){return l({method:"POST",url:API.Mapping.CAMPUS_DELETE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},allBuildings:function(e){return l({method:"POST",url:API.Mapping.BUILDING_ALL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},allOwnerBuildings:function(e){return l({method:"POST",url:API.Mapping.BUILDING_ALL_OWNER_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},allCucodeCampus:function(e){return l({method:"POST",url:API.Mapping.BUILDINGSET_ALL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},allCampus:function(e){return l({method:"POST",url:API.Mapping.CAMPUS_ALL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},addFloor:function(e){return l({method:"POST",url:API.Mapping.FLOOR_ADD_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deleteFloor:function(e){return l({method:"POST",url:API.Mapping.FLOOR_DELETE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},allBuildingFloors:function(e){return l({method:"POST",url:API.Mapping.FLOOR_ALL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},uploadFloorPlan:function(e,t){return l({method:"POST",url:API.Mapping.FLOOR_PLAN_UPLOAD_URL,headers:{"Content-Type":"multipart/form-data"},data:{floorplan:t,json:e},transformRequest:o}).success(function(e,t){return e}).error(function(e,t){return e})},uploadFloorPlan64:function(e,t){var o=t.replace("data:image/png;base64,",""),i=LPUtils.Base64Binary.decode(o),n=new Blob([i]);o="";for(var a=0;a<i.length;a++)o+=i[a];var r=new FormData;return r.append("json",e),r.append("floorplan",n),l.post(API.Mapping.FLOOR_PLAN_UPLOAD_URL,r,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e,t){return e}).error(function(e,t){return e})},downloadFloorPlan:function(e,t,o){return l({method:"POST",url:API.Mapping.FLOOR_PLAN_DOWNLOAD_URL+t+"/"+o,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},downloadFloorPlanAll:function(e,t,o){return l({method:"POST",url:API.Mapping.FLOOR_PLAN_DOWNLOAD_URL_ALL+t+"/"+o,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},addPois:function(e){return l({method:"POST",url:API.Mapping.POIS_ADD_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},updatePois:function(e){return l({method:"POST",url:API.Mapping.POIS_UPDATE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deletePois:function(e){return l({method:"POST",url:API.Mapping.POIS_DELETE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},retrievePoisByBuildingFloor:function(e){return l({method:"POST",url:API.Mapping.POIS_ALL_FLOOR_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},addConnection:function(e){return l({method:"POST",url:API.Mapping.CONNECTION_ADD_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},deleteConnection:function(e){return l({method:"POST",url:API.Mapping.CONNECTION_DELETE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},retrieveConnectionsByBuildingFloor:function(e){return l({method:"POST",url:API.Mapping.CONNECTION_ALL_FLOOR_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},loginGoogle:function(e){return LOG.D4("loginGoogle"),LOG.D4(e),l({method:"POST",url:API.Mapping.LOGIN_GOOGLE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},refreshLocalAccount:function(e){return l({method:"POST",url:API.Mapping.LOGIN_REFRESH_LOCAL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},loginLocalAccount:function(e){return l({method:"POST",url:API.Mapping.LOGIN_LOCAL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},registerLocalAccount:function(e){return LOG.D2("api.js"),l({method:"POST",url:API.Mapping.REGISTER_LOCAL_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},getOneBuilding:function(e){return l({method:"POST",url:API.Mapping.BUILDING_ONE_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},retrieveALLPois:function(e){return l({method:"POST",url:API.Mapping.ALL_POIS_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},retrieveRouteFromPoiToPoi:function(e){return l({method:"POST",url:API.Navigation.POIS_ROUTE,data:e}).success(function(e,t){return e}).error(function(e,t){return e})},googleUrlShortener:function(e){return l({method:"POST",url:API.Other.GOOGLE_URL_SHORTNER_URL,data:e}).success(function(e,t){return e}).error(function(e,t){return e})}};return t}]);var MIN_ZOOM_FOR_HEATMAPS=19,MAX_ZOOM_FOR_HEATMAPS=21,_MAX_ZOOM_LEVEL=22,DEFAULT_MAP_TILES="CartoLight";ERR_FETCH_BUILDINGS="Something went wrong while fetching buildings.",ERR_FETCH_ALL_FLOORS="Something went wrong while fetching all floors.",ERR_USER_AUTH="Could not authorize user. Please refresh.",ERR_FETCH_FINGERPRINTS="Something went wrong while fetching fingerprints.",ERR_GEOLOC_DEVICE_SETTINGS="Please enable location access.",ERR_GEOLOC_NET_OR_SATELLITES="Position unavailable. The network is down or the positioning satellites couldn't be contacted.",ERR_GEOLOC_TIMEOUT="Timeout. The request for retrieving your Geolocation was timed out.",ERR_GEOLOC_UNKNOWN="There was an error while retrieving your Geolocation. Please try again.",ERR_GEOLOC_NOT_SUPPORTED="The Geolocation feature is not supported by this browser.",WARN_NO_FINGERPRINTS="This floor seems not to be FingerPrint mapped. Download the Anyplace app from the Google Play store to map the floor.",WARN_ACCES_REMOVED="ACCES map removed.";var cAccessPointsWifi="accessPointsWifi",cSpaces="spaces",cCampuses="campuses",cEdges="edges",cFingerprintsWifi="fingerprintsWifi",cFloorplans="floorplans",cPOIS="pois",cUsers="users",cFingerprintTime="cFingerprintTime",cHeatmapWifi1="heatmapWifi1",cHeatmapWifi2="heatmapWifi2",cHeatmapWifi3="heatmapWifi3",fAccessToken="access_token",fAddress="address",fBuCode="bucode",fBuid="buid",fBuids="buids",fBuidA="buid_a",fBuidB="buid_b",fCoOwners="co_owners",fCoordinates="coordinates",fCoordinatesLat="coordinates_lat",fCoordinatesLon="coordinates_lon",fCampusCuid="cuid",fConCuid="cuid",fDescription="description",fEdgeType="edge_type",fExternal="external",fFloor="floor",fFloorA="floor_a",fFloorB="floor_b",fFloorName="floor_name",fFloorNumber="floor_number",fFuid="fuid",fGeometry="geometry",fGreeklish="greeklish",fHeading="heading",fId="_id",fIsBuildingEntrance="is_building_entrance",fIsDoor="is_door",fIsPublished="is_published",fImage="image",fLatTopRight="top_right_lat",fLatBottomLeft="bottom_left_lat",fLonBottomLeft="bottom_left_lng",fLonTopRight="top_right_lng",fLocation="location",fMac="MAC",fMeasurements="measurements",fName="name",fOwnerId="owner_id",fPoisA="pois_a",fPoisB="pois_b",fPoisType="pois_type",fPuid="puid",fRSS="rss",fSchema="_schema",fStrongestWifi="strongestWifi",fTimestamp="timestamp",fTimestampX="timestampX",fTimestampY="timestampY",fType="type",fURL="url",fWeight="weight",fX="x",fY="y",fZoom="zoom",IMG_ACCESS_POINT_ARCHITECT="build/images/wireless-router-icon-bg.png",IMG_BUILDING_ARCHITECT="build/images/building-icon.png",IMG_BUILDING_VIEWER="build/images/building-icon-viewer.png",IMG_FINGERPRINT_RED_SPOT="build/images/red_dot.png";function __addAlert(e,t,o){e.anyService.addAlert(t,o)}function _err(e,t){__addAlert(e,"danger",t)}$("document").ready(function(){$("#myModal_Welcome").on("shown.bs.modal",function(){$("#myModal_Welcome").trigger("focus")}),$("[rel=tooltip]").length&&$("[rel=tooltip]").tooltip()});var _suc=function(e,t){__addAlert(e,"success",t)},_warn=function(e,t){__addAlert("warning",t)},_warn_autohide=function(e,t){__addAlert(e,"warning",t),window.setTimeout(function(){$(".alert-warning").fadeTo(500,0).slideUp(500,function(){$(this).remove()})},5e3)},_info=function(e,t){__addAlert(e,"info",t),window.setTimeout(function(){$(".alert-info").fadeTo(500,0).slideUp(500,function(){$(this).remove()})},1e4)};function _ShowAlert(e,t,o,i,n){var a=o.data,r=i;null!=a&&null!=a.message&&(n?r+=": "+a.message:r=a.message),t(e,r)}function ShowError(e,t,o,i){_ShowAlert(e,_err,t,o,i=i||!1)}function ShowWarningAutohide(e,t,o,i){_ShowAlert(e,_warn_autohide,t,o,i=i||!1)}function HandleGeolocationError(e,t){_warn_autohide(e,1===t?ERR_GEOLOC_DEVICE_SETTINGS:2===t?ERR_GEOLOC_NET_OR_SATELLITES:3===t?ERR_GEOLOC_TIMEOUT:ERR_GEOLOC_UNKNOWN)}function selectAllInputText(e){e.setSelectionRange(0,e.value.length)}function getMapsIconBuildingViewer(e,t){var o=new google.maps.Size(27.5,40);return e.isFirefox&&(o=new google.maps.Size(55,80)),new google.maps.Marker({position:t,icon:{url:IMG_BUILDING_VIEWER,size:o,scaledSize:new google.maps.Size(27.5,40)},draggable:!1})}function getMapsIconBuildingArchitect(e,t){return new google.maps.Marker({position:t,map:e,icon:new google.maps.MarkerImage(IMG_BUILDING_ARCHITECT,null,null,null,new google.maps.Size(54,54)),draggable:!1})}function getMapsIconFingerprint(e,t){var o=new google.maps.Size(25,25);return new google.maps.Marker({position:t.location,map:e,icon:new google.maps.MarkerImage(IMG_FINGERPRINT_RED_SPOT,null,null,null,o)})}function clearFingerprintCoverage(){if(void 0!==heatMap[0]&&null!==heatMap[0]){for(var e=heatMap.length;e--;)heatMap[e].rectangle.setMap(null),heatMap[e]=null;heatMap=[],document.getElementById("radioHeatmapRSS-mode").classList.remove("quickaction-selected"),_HEATMAP_FINGERPRINT_COVERAGE=!1,setColorClicked("g",!1),setColorClicked("y",!1),setColorClicked("o",!1),setColorClicked("p",!1),setColorClicked("r",!1),$scope.radioHeatmapRSSMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","NO"),$scope.anyService.radioHeatmapRSSMode=!1,$scope.radioHeatmapRSSHasGreen=!1,$scope.radioHeatmapRSSHasYellow=!1,$scope.radioHeatmapRSSHasOrange=!1,$scope.radioHeatmapRSSHasPurple=!1,$scope.radioHeatmapRSSHasRed=!1,$cookieStore.put("RSSClicked","NO")}}function clearFingerprintHeatmap(){if(void 0!==fingerPrintsMap[0]&&null!==fingerPrintsMap[0]){for(var e=fingerPrintsMap.length;e--;)fingerPrintsMap[e].setMap(null),fingerPrintsMap[e]=null;_FINGERPRINTS_IS_ON=!(fingerPrintsMap=[]),document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected")}if(heatmap&&heatmap.getMap()){heatmap.setMap(null),_FINGERPRINTS_IS_ON=!1,document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),_HEATMAP_F_IS_ON=!1;for(e=heatmapFingerprints.length;e--;)heatmapFingerprints[e]=null;heatmapFingerprints=[]}}function isNullOrEmpty(e){return null==e||null==e||""==e||"-"==e}function getPrettyVersion(e){var t=e.version;return null!=e.variant&&""!==e.variant&&(t+="-"+e.variant),t}var LOG={};function CanvasOverlay(e,t){for(this.top=0,this.left=0,this.width=e.width,this.height=e.height;window&&(this.width>window.innerWidth||this.height>window.innerHeight);)this.width/=2,this.height/=2;this.image_=e,this.map_=t,this.div_=null,this.canvas=null,this.ctx=null,this.angle=0,this.scale=1,this.latlng=t.getCenter(),this.new_left=0,this.new_top=0,this.setMap(t)}function deg2rad(e){return e*Math.PI/180}function rad2deg(e){return e/Math.PI*180}function getRotationDegrees(e){var t=e.css("-webkit-transform")||e.css("-moz-transform")||e.css("-ms-transform")||e.css("-o-transform")||e.css("transform");if("none"!==t)var o=t.split("(")[1].split(")")[0].split(","),i=o[0],n=o[1],a=(o[2],o[3],Math.sqrt(i*i+n*n),Math.round(Math.atan2(n,i)*(180/Math.PI)));else a=0;return a}LOG.level=2,LOG.DBG1=function(){return 1<=LOG.level},LOG.DBG2=function(){return 2<=LOG.level},LOG.DBG3=function(){return 3<=LOG.level},LOG.DBG4=function(){return 4<=LOG.level},LOG.W=function(e){console.log("WARN: "+e)},LOG.E=function(e){console.log("ERR: "+e)},LOG.D=function(e){console.log(e)},LOG.F=function(e){alert(e),window.stop()},LOG.D1=function(e){LOG.DBG1()&&console.log(e)},LOG.D2=function(e){LOG.DBG2()&&console.log(e)},LOG.D3=function(e){LOG.DBG3()&&console.log(e)},LOG.D4=function(e){LOG.DBG4()&&console.log(e)},CanvasOverlay.prototype=new google.maps.OverlayView,CanvasOverlay.prototype.onAdd=function(){var n,e=document.createElement("div");if(e.id="canvas_editor",e.style.border="none",e.style.borderWidth="0px",e.style.position="relative",e.style.top=this.top,e.style.left=this.left,null!=(n=this.getProjection())){var t=n.fromLatLngToDivPixel(this.latlng);e.style.top=t.y-this.height/2+"px",e.style.left=t.x-this.width/2+"px"}var a=this;function r(e){return parseInt(e,10)||0}function L(e){return isNaN(parseFloat(e))?0:parseFloat(e)}function T(e){return Math.round(100*(e+1e-5))/100}jQuery.getCorrection=function(e,t,o,i,n){n=n*Math.PI/180;var a,r=-e/2,l=(a=t/2)*Math.sin(n)+r*Math.cos(n)-r,s=a*Math.cos(n)-r*Math.sin(n)-a;r=-(e+o)/2;return{left:(a=(t+i)/2)*Math.sin(n)+r*Math.cos(n)-r-l,top:a*Math.cos(n)-r*Math.sin(n)-a-s}},jQuery.ui.resizable.prototype._mouseStart=function(e){var t,o,i,n=this.options,a=this.element;return this.resizing=!0,this._renderProxy(),t=r(this.helper.css("left")),o=r(this.helper.css("top")),n.containment&&(t+=$(n.containment).scrollLeft()||0,o+=$(n.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:t,top:o},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:a.width(),height:a.height()},this.originalSize=this._helper?{width:a.outerWidth(),height:a.outerHeight()}:{width:a.width(),height:a.height()},this.sizeDiff={width:a.outerWidth()-a.width(),height:a.outerHeight()-a.height()},this.originalPosition={left:t,top:o},this.originalMousePosition={left:e.pageX,top:e.pageY},this.lastData=this.originalPosition,this.aspectRatio="number"==typeof n.aspectRatio?n.aspectRatio:this.originalSize.width/this.originalSize.height||1,i=$(".ui-resizable-"+this.axis).css("cursor"),$("body").css("cursor","auto"===i?this.axis+"-resize":i),a.addClass("ui-resizable-resizing"),this._propagate("start",e),!0},jQuery.ui.resizable.prototype._mouseDrag=function(e){var t,o=function(e){var t=window.getComputedStyle(e,null),o=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||null;{if(o&&"none"!=o){for(var i=o.split("(")[1],n=(i=(i=i.split(")")[0]).split(","))[0],a=i[1],r=Math.round(Math.atan2(a,n)*(180/Math.PI));360<=r;)r=360-r;for(;r<0;)r=360+r;return r}return 0}}(this.element[0]),i=o*Math.PI/180,n=this.helper,a={},r=this.originalMousePosition,l=this.axis,s=this.position.top,d=this.position.left,c=this.size.width,p=this.size.height,u=e.pageX-r.left||0,g=e.pageY-r.top||0,m=this._change[l],f=this.size.width,h=this.size.height;if(!m)return!1;var _=Math.cos(i),y=Math.sin(i),P=g*_-u*y;u=u*_+g*y,g=P,t=m.apply(this,[e,u,g]),this._updateVirtualBoundaries(e.shiftKey),(this._aspectRatio||e.shiftKey)&&(t=this._updateRatio(t,e)),t=this._respectSize(t,e);var S={left:this.position.left,top:this.position.top};this._updateCache(t),this.position={left:S.left,top:S.top};var v=L(t.left||this.lastData.left)-L(this.lastData.left),I=L(t.top||this.lastData.top)-L(this.lastData.top),M={};M.left=v*_-I*y,M.top=I*_+v*y,M.left=T(M.left),M.top=T(M.top),this.position.left+=M.left,this.position.top+=M.top,this.lastData={left:L(t.left||this.lastData.left),top:L(t.top||this.lastData.top)},this._propagate("resize",e);var A=f-this.size.width,O=h-this.size.height,b=$.getCorrection(f,h,A,O,o);return this.position.left+=b.left,this.position.top-=b.top,this.position.top!==s&&(a.top=this.position.top+"px"),this.position.left!==d&&(a.left=this.position.left+"px"),this.size.width!==c&&(a.width=this.size.width+"px"),this.size.height!==p&&(a.height=this.size.height+"px"),n.css(a),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),$.isEmptyObject(a)||this._trigger("resize",e,this.ui()),!1},jQuery(e).resizable({ghost:!0,handles:"sw, se, nw, ne",helper:"resizable-helper",aspectRatio:!1,stop:function(e,t){a.ctx.clearRect(0,0,a.ctx.canvas.width,a.ctx.canvas.height),a.width=t.size.width,a.height=t.size.height,a.setCanvasSize(),a.ctx.save(),a.ctx.translate(a.ctx.canvas.width/2,a.ctx.canvas.height/2),a.ctx.drawImage(a.image_,-a.width/2,-a.height/2,a.width,a.height),a.ctx.restore()}}).rotatable({stop:function(e,t){}}),jQuery(e).draggable({stop:function(e,t){if(null!=n){var o=$(this).position().left,i=$(this).position().top;a.latlng=n.fromDivPixelToLatLng(new google.maps.Point(o,i),!0)}}});var o=document.createElement("canvas");o.id="canvas",e.appendChild(o),this.div_=e,this.canvas=o,this.ctx=o.getContext("2d"),this.initImage(),this.getPanes().overlayImage.appendChild(this.div_);var i=this,l=e;return google.maps.event.addDomListener(this.get("map").getDiv(),"mouseleave",function(){google.maps.event.trigger(l,"mouseup")}),google.maps.event.addDomListener(l,"mousedown",function(e){this.style.cursor="move",i.map_.set("draggable",!1),i.set("origin",e)}),google.maps.event.addDomListener(l,"mouseup",function(){i.map_.set("draggable",!0),this.style.cursor="default",google.maps.event.removeListener(i.moveHandler)}),this},CanvasOverlay.prototype.draw=function(){this.div_;null==this.canvas&&alert("error creating the canvas")},CanvasOverlay.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_)},CanvasOverlay.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},CanvasOverlay.prototype.show=function(){this.div_&&(this.div_.style.visibility="visible")},CanvasOverlay.prototype.toggle=function(){this.div_&&("hidden"==this.div_.style.visibility?this.show():this.hide())},CanvasOverlay.prototype.toggleDOM=function(){this.getMap()?this.setMap(null):this.setMap(this.map_)},CanvasOverlay.prototype.getCanvas=function(){return this.canvas},CanvasOverlay.prototype.getContext2d=function(){return this.ctx},CanvasOverlay.prototype.setCanvasSize=function(){this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.div_.style.width=this.width+"px",this.div_.style.height=this.height+"px"},CanvasOverlay.prototype.initImage=function(){this.setCanvasSize(),this.ctx.save(),this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.rotate(this.angle),this.ctx.drawImage(this.image_,-this.width/2,-this.height/2,this.width,this.height),this.ctx.restore()},CanvasOverlay.prototype.drawBoundingCanvas=function(){var e=deg2rad(getRotationDegrees($("#canvas_editor")));$("#canvas_editor").css({"-moz-transform":"rotate(0deg)","-webkit-transform":"rotate(0deg)","-ms-transform":"rotate(0deg)","-o-transform":"rotate(0deg)",transform:"rotate(0deg)"});var t,o=getPositionData($("#canvas_editor")),i=o.left,n=o.top,a=i+this.width/2,r=n+this.height/2,l=a+(i-a)*Math.cos(e)+(n-r)*Math.sin(e),s=r-(i-a)*Math.sin(e)+(n-r)*Math.cos(e),d=a+(i+this.width-a)*Math.cos(e)+(n-r)*Math.sin(e),c=r-(i+this.width-a)*Math.sin(e)+(n-r)*Math.cos(e),p=a+(i-a)*Math.cos(e)+(n+this.height-r)*Math.sin(e),u=r-(i-a)*Math.sin(e)+(n+this.height-r)*Math.cos(e),g=a+(i+this.width-a)*Math.cos(e)+(n+this.height-r)*Math.sin(e),m=r-(i+this.width-a)*Math.sin(e)+(n+this.height-r)*Math.cos(e),f=Math.max(l,d,p,g),h=Math.max(s,c,u,m),_=Math.min(l,d,p,g),y=Math.min(s,c,u,m),P=y,S=_,v=f-_,I=h-y;$("#canvas_editor").css({top:P+"px",left:S+"px"}),this.ctx.canvas.width=v,this.ctx.canvas.height=I,this.ctx.save(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.translate(a-S,r-P),this.ctx.rotate(e),this.ctx.drawImage(this.image_,-this.width/2,-this.height/2,this.width,this.height),this.ctx.restore(),this.top=P,this.left=S,null!=(t=this.getProjection())&&(this.bottom_left_coords=t.fromContainerPixelToLatLng(new google.maps.Point(this.left,this.top+I),!0),this.top_right_coords=t.fromContainerPixelToLatLng(new google.maps.Point(this.left+v,this.top),!0))};var getPositionData=function(e){return $.extend({width:e.outerWidth(!1),height:e.outerHeight(!1)},e.offset())},LPUtils={};function hexToBase64(e){return btoa(String.fromCharCode.apply(null,e.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")))}function base64_encode(e){var t,o,i,n,a,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,s=0,d="",c=[];if(!e)return e;for(;t=(a=e.charCodeAt(l++)<<16|e.charCodeAt(l++)<<8|e.charCodeAt(l++))>>18&63,o=a>>12&63,i=a>>6&63,n=63&a,c[s++]=r.charAt(t)+r.charAt(o)+r.charAt(i)+r.charAt(n),l<e.length;);d=c.join("");var p=e.length%3;return(p?d.slice(0,p-3):d)+"===".slice(p||3)}function USGSOverlay(e,t,o){this.bounds_=e,this.image_=t,this.image64=t,this.map_=o,this.div_=null,this.setMap(o)}LPUtils.isNullOrUndefined=function(e){return null==e},LPUtils.isStringEmptyNullUndefined=function(e){return!e||0===e.length},LPUtils.isStringBlankNullUndefined=function(e){return!e||/^\s*$/.test(e)},LPUtils.alert=function(e){document.getElementById("notification_panel").innerHTML='<alert type="error" close="LPUtils.closeAlert()">'+e+"</alert>"},LPUtils.closeAlert=function(){document.getElementById("notification_panel").getEl.innerHTML=""},LPUtils.success=function(e){document.getElementById("notification_panel").innerHTML='<alert type="success">'+e+"</alert>"},LPUtils.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,o,i,n,a,r,l,s="",d=0;for(e=LPUtils.Base64._utf8_encode(e);d<e.length;)n=(t=e.charCodeAt(d++))>>2,a=(3&t)<<4|(o=e.charCodeAt(d++))>>4,r=(15&o)<<2|(i=e.charCodeAt(d++))>>6,l=63&i,isNaN(o)?r=l=64:isNaN(i)&&(l=64),s=s+this._keyStr.charAt(n)+this._keyStr.charAt(a)+this._keyStr.charAt(r)+this._keyStr.charAt(l);return s},decode:function(e){var t,o,i,n,a,r,l="",s=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");s<e.length;)t=this._keyStr.indexOf(e.charAt(s++))<<2|(n=this._keyStr.indexOf(e.charAt(s++)))>>4,o=(15&n)<<4|(a=this._keyStr.indexOf(e.charAt(s++)))>>2,i=(3&a)<<6|(r=this._keyStr.indexOf(e.charAt(s++))),l+=String.fromCharCode(t),64!=a&&(l+=String.fromCharCode(o)),64!=r&&(l+=String.fromCharCode(i));return l=LPUtils.Base64._utf8_decode(l)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",o=0;o<e.length;o++){var i=e.charCodeAt(o);i<128?t+=String.fromCharCode(i):(127<i&&i<2048?t+=String.fromCharCode(i>>6|192):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128)),t+=String.fromCharCode(63&i|128))}return t},_utf8_decode:function(e){for(var t="",o=0,i=c1=c2=0;o<e.length;)(i=e.charCodeAt(o))<128?(t+=String.fromCharCode(i),o++):191<i&&i<224?(c2=e.charCodeAt(o+1),t+=String.fromCharCode((31&i)<<6|63&c2),o+=2):(c2=e.charCodeAt(o+1),c3=e.charCodeAt(o+2),t+=String.fromCharCode((15&i)<<12|(63&c2)<<6|63&c3),o+=3);return t}},LPUtils.Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(e){var t=e.length/4*3,o=new ArrayBuffer(t);return this.decode(e,o),o},decode:function(e,t){var o,i,n,a,r,l,s,d=this._keyStr.indexOf(e.charAt(e.length-1)),c=this._keyStr.indexOf(e.charAt(e.length-2)),p=e.length/4*3;64==d&&p--,64==c&&p--;var u=0,g=0;for(o=t?new Uint8Array(t):new Uint8Array(p),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),u=0;u<p;u+=3)i=this._keyStr.indexOf(e.charAt(g++))<<2|(r=this._keyStr.indexOf(e.charAt(g++)))>>4,n=(15&r)<<4|(l=this._keyStr.indexOf(e.charAt(g++)))>>2,a=(3&l)<<6|(s=this._keyStr.indexOf(e.charAt(g++))),o[u]=i,64!=l&&(o[u+1]=n),64!=s&&(o[u+2]=a);return o}},USGSOverlay.prototype=new google.maps.OverlayView,USGSOverlay.prototype.onAdd=function(){var e=document.createElement("div");e.id="ground_overlay",e.style.borderStyle="none",e.style.borderWidth="0px",e.style.position="absolute";var t=document.createElement("img");t.src=this.image64,t.style.width="100%",t.style.height="100%",t.style.position="absolute",e.appendChild(t),this.div_=e,this.getPanes().overlayLayer.appendChild(e)},USGSOverlay.prototype.draw=function(){var e=this.getProjection(),t=e.fromLatLngToDivPixel(this.bounds_.getSouthWest()),o=e.fromLatLngToDivPixel(this.bounds_.getNorthEast()),i=this.div_;i.style.left=t.x+"px",i.style.top=o.y+"px",i.style.width=o.x-t.x+"px",i.style.height=t.y-o.y+"px"},USGSOverlay.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},app.controller("AlertController",["$rootScope","$scope","AnyplaceService",function(e,t,o){t.anyService=o,t.alerts=o.alerts,t.closeable=!0}]),app.controller("BuildingController",["$cookieStore","$scope","$compile","GMapService","AnyplaceService","AnyplaceAPIService",function(e,m,s,d,g,f){function t(){return(65536*(1+Math.random())|0).toString(16).substring(1)}m.myMarkers={},m.myMarkerId=0,m.gmapService=d,m.anyService=g,m.anyAPI=f,m.example9model=[],m.example9data=[],m.example9settings={enableSearch:!0,scrollable:!0},m.example9modeledit=[],m.example9dataedit=[],m.example9settingsedit={enableSearch:!0,scrollable:!0},m.myBuildings=[],m.myBuildingsHashT={},m.myCampus=[],m.old_campus=[],m.crudTabSelected=1,m.fileToUpload="",m.logfile="",m.poisTypes={},m.catTypes={},m.spaceTypes={},m.pageLoad=!1,m.crudTabSelected=1,m.fetchVersion=function(){m.anyAPI.version({}).then(function(e){var t=getPrettyVersion(e.data);LOG.D3("Anyplace Version: "+t),document.getElementById("anyplace-version").textContent="v"+t},function(e){console.log("Failed to get version: "+e.data)})},m.fetchVersion(),m.setCrudTabSelected=function(e){if(m.crudTabSelected=e,m.anyService.getBuilding()){var t=m.myBuildingsHashT[m.anyService.getBuildingId()];if(t){var o=t.marker;o&&(2===e?o.setDraggable(!0):o.setDraggable(!1))}}else _err(m,"No building selected.")},m.isCrudTabSelected=function(e){return m.crudTabSelected===e},m.$on("loggedIn",function(e,t){m.fetchAllBuildings(),m.fetchAllCampus()}),m.$on("loggedOff",function(e,t){n(),m.myMarkers={},m.myMarkerId=0,m.myBuildings=[],m.myBuildingsHashT={}});var o=(t()+t()+"-"+t()+"-4"+t().substr(0,3)+"-"+t()+"-"+t()+t()+t()).toLowerCase(),i=new Date;document.getElementById("CampusID").value="cuid_"+o+"_"+i.getTime(),$("#input-logo").change(function(e){var t=new FileReader;t.onload=function(e){(new Image).src=e.target.result},t.readAsDataURL(e.target.files[0])}),m.setLogoPlan=function(e){var t={is_published:"true",cuid:e,logo:String(m.newFloorNumber),description:String(m.newFloorNumber),floor_number:String(m.newFloorNumber)};m.myFloors[m.myFloorId]=t,m.myFloorId++,canvasOverlay.drawBoundingCanvas();var o=canvasOverlay.bottom_left_coords,i=canvasOverlay.top_right_coords;m.data.floor_plan_coords.bottom_left_lat=o.lat(),m.data.floor_plan_coords.bottom_left_lng=o.lng(),m.data.floor_plan_coords.top_right_lat=i.lat(),m.data.floor_plan_coords.top_right_lng=i.lng(),m.data.floor_plan_coords.zoom=d.gmap.getZoom()+"";var n=canvasOverlay.getCanvas().toDataURL("image/png");m.data.floor_plan_base64_data=n;var a=new google.maps.LatLngBounds(new google.maps.LatLng(o.lat(),o.lng()),new google.maps.LatLng(i.lat(),i.lng()));if(m.data.floor_plan_groundOverlay=new USGSOverlay(a,n,d.gmap),canvasOverlay.setMap(null),$("#input-floor-plan").prop("disabled",!1),m.isCanvasOverlayActive=!1,_floorNoExists(m.newFloorNumber))for(var r=0;r<m.xFloors.length;r++){var l=m.xFloors[r];if(!LPUtils.isNullOrUndefined(l)&&l.floor_number===String(m.newFloorNumber)){m.uploadWithZoom(m.anyService.selectedBuilding,l,m.data);break}}else m.addFloorObject(t,m.anyService.selectedBuilding,m.data)},m.$watch("anyService.selectedBuilding",function(e,t){e&&e.coordinates_lat&&e.coordinates_lon&&(m.gmapService.gmap.panTo(c(e)),m.gmapService.gmap.setZoom(19),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastBuilding",e.buid)),m.poisTypes=["Disabled Toilets","Elevator","Entrance","Fire Extinguisher","First Aid/AED","Kitchen","Office","Ramp","Room","Security/Guard","Stair","Toilets","Other"]}),m.$watch("anyService.selectedBuilding",function(){m.spaceTypes=["building","vessel"],m.spacecategories=[{spacecat:"building",id:"type1"},{spacecat:"vessel",id:"type2"}]}),m.$watch("anyService.selectedCampus",function(e,t){e&&e.cuid&&"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastCampus",e.cuid)});var n=function(){for(var e in m.myBuildingsHashT)m.myBuildingsHashT.hasOwnProperty(e)&&(m.myBuildingsHashT[e].marker.setMap(null),delete m.myBuildingsHashT[e])},c=function(e){if(e&&e.coordinates_lat&&e.coordinates_lon)return{lat:parseFloat(e.coordinates_lat),lng:parseFloat(e.coordinates_lon)}};m.fetchAllBuildings=function(){var e={};LOG.D2("fetchAllBuildings"),LOG.D4(e),m.anyAPI.allOwnerBuildings(e).then(function(e){var t=e.data;m.myBuildings=t.spaces;var o=new google.maps.InfoWindow({content:"-",maxWidth:500}),i=-1,n=void 0;"undefined"!=typeof Storage&&localStorage&&localStorage.getItem("lastBuilding")&&(n=localStorage.getItem("lastBuilding"));for(var a=0;a<m.myBuildings.length;a++){var r=m.myBuildings[a];m.example9data[a]={id:r.buid,label:r.name},m.example9dataedit[a]={id:r.buid,label:r.name},n&&n===r.buid&&(i=a),"true"===r.is_published||1==r.is_published?r.is_published=!0:r.is_published=!1;var l=getMapsIconBuildingArchitect(d.gmap,c(r)),s='<div class="infowindow-scroll-fix"><div class="infowindow-title">'+r.name+'</div><div class="font-weight-bold">BUID:</div><input class="form-control input-tiny" value="'+r.buid+'" onClick="selectAllInputText(this)" readonly/><div class="infowindow-title">Description:</div><textarea class="infowindow-text-area"  rows="3" readonly>'+r.description+"</textarea></div>";l.infoContent=s,l.building=r,m.myBuildingsHashT[r.buid]={marker:l,model:r},google.maps.event.addListener(l,"click",function(){o.setContent(this.infoContent),o.open(d.gmap,this);var e=this;m.$apply(function(){m.anyService.selectedBuilding=e.building})})}console.log("Loaded "+m.myBuildings.length+" buildings!"),0<=i?m.anyService.selectedBuilding=m.myBuildings[i]:m.myBuildings[0]&&(m.anyService.selectedBuilding=m.myBuildings[0])},function(e){ShowError(m,e,ERR_FETCH_BUILDINGS)})},m.addNewBuilding=function(o){if(m.myMarkers[o]&&m.myMarkers[o].marker){var i=m.myMarkers[o].model;if(i.coordinates_lat=String(m.myMarkers[o].marker.position.lat()),i.coordinates_lon=String(m.myMarkers[o].marker.position.lng()),void 0===i.coordinates_lat||null===i.coordinates_lat)return void _err(m,"Invalid building latitude.");if(void 0===i.coordinates_lon||null===i.coordinates_lon)return void _err(m,"Invalid building longitude.");if(!0===i.is_published?i.is_published="true":i.is_published="false",i.description||(i.description="-"),i.name&&i.description&&i.is_published&&i.url&&i.address&&i.space_type)m.anyAPI.addBuilding(i).then(function(e){var t=e.data;console.log("new buid: "+t.buid),i.buid=t.buid,"true"===i.is_published||1==i.is_published?i.is_published=!0:i.is_published=!1,m.myBuildings.push(i),m.anyService.selectedBuilding=m.myBuildings[m.myBuildings.length-1],m.myMarkers[o].marker.setDraggable(!1),m.myBuildingsHashT[i.buid]={marker:m.myMarkers[o].marker,model:i},m.myMarkers[o].infowindow&&(m.myMarkers[o].infowindow.setContent(m.myMarkers[o].marker.tpl2[0]),m.myMarkers[o].infowindow.close()),_suc(m,"Building added successfully.")},function(e){ShowError(m,e,"Something went wrong while adding the building.",!0)});else _err(m,"Some required fields are missing.")}},m.deleteBuilding=function(){var n=m.anyService.getBuilding(),e=m.creds;e.buid=n.buid,m.anyAPI.deleteBuilding(e).then(function(e){e.data;console.log("building deleted: ",n),m.myBuildingsHashT[n.buid].marker.setMap(null),delete m.myBuildingsHashT[n.buid];for(var t=m.myBuildings,o=t.length,i=0;i<o;i++)if(t[i].buid==n.buid){t.splice(i,1);break}m.myBuildings&&0<m.myBuildings.length&&(m.anyService.selectedBuilding=m.myBuildings[0]),m.setCrudTabSelected(1),_suc(m,"Successfully deleted indoor space.")},function(e){ShowError(m,e,"Something went wrong.It's likely that everything related to the indoor space is deleted but please refresh to make sure or try again.",!0)})},m.deleteRadiomaps=function(){var e={buid:m.anyService.getBuildingId(),floor:m.anyService.getFloorNumber()};e.username=m.creds.username,e.password=m.creds.password,m.anyAPI.deleteRadiomaps(e).then(function(e){_suc(m,"Deleted radiomap floor")},function(e){ShowError(m,e,"deleteRadiomaps: file does not exist.",!0)})},m.updateBuilding=function(){var t=m.anyService.getBuilding();if(LPUtils.isNullOrUndefined(t)||LPUtils.isNullOrUndefined(t.buid))_err(m,"No selected building found.");else{var e={};e.buid=t.buid,e.description=t.description,isNullOrEmpty(t.description)&&(e.description=""),t.name&&(e.name=t.name),!0===t.is_published||"true"==t.is_published?e.is_published="true":e.is_published="false",e.bucode=t.bucode,isNullOrEmpty(t.bucode)&&(e.bucode=""),e.space_type=t.type,LOG.D2(t);var o=m.myBuildingsHashT[t.buid].marker;if(o){var i=o.position;i&&i.lat()&&i.lng()&&(e.coordinates_lat=String(i.lat()),e.coordinates_lon=String(i.lng()))}m.anyAPI.updateBuilding(e).then(function(e){e.data;"true"===t.is_published||1==t.is_published?t.is_published=!0:t.is_published=!1,_suc(m,"Successfully updated building.")},function(e){ShowError(m,e,"Something went wrong while updating building.",!0)})}},m.fetchAllCampus=function(){m.myCampus=[],m.anyAPI.allCampus({}).then(function(e){var t=e.data;m.myCampus=t.buildingsets;var o=-1,i=void 0;"undefined"!=typeof Storage&&localStorage&&localStorage.getItem("lastCampus")&&(i=localStorage.getItem("lastCampus"));for(var n=0;n<m.myCampus.length;n++){var a=m.myCampus[n];i&&i===a.cuid&&(o=n)}0<=o?m.anyService.selectedCampus=m.myCampus[o]:m.myCampus[0]&&(m.anyService.selectedCampus=m.myCampus[0])},function(e){ShowError(m,e,ERR_FETCH_BUILDINGS)})},m.updateCampus=function(){var e=m.anyService.getCampus();if(LPUtils.isNullOrUndefined(e)||LPUtils.isNullOrUndefined(e.cuid))_err(m,"No selected campus found.");else{var t={};t.cuid=e.cuid,t.description=e.description,isNullOrEmpty(e.description)&&(t.description=""),t.name=e.name,isNullOrEmpty(e.name)&&(t.name=""),e.newcuid&&(t.newcuid=e.newcuid);var o=m.example9modeledit.length;if(0!=o){for(var i=[],n=o-1;0<n;n--)i[n]=m.example9modeledit[n].id;i[0]=m.example9modeledit[0].id,LOG.D2(i),t.greeklish=document.getElementById("Greeklish-OnOffedit").checked,t.buids=i,m.anyAPI.updateCampus(t).then(function(e){e.data;document.getElementById("CampusIDeditnew").value="",_suc(m,"Successfully updated campus.")},function(e){ShowError(m,e,"Something went wrong while updating campus.",!0)})}else _err(m,"No buildings selected.")}},m.deleteCampus=function(){var n=m.anyService.getCampus();if(n&&n.cuid){var e={};e.cuid=n.cuid,m.anyAPI.deleteCampus(e).then(function(e){e.data;for(var t=m.myCampus,o=t.length,i=0;i<o;i++)if(t[i].cuid==n.cuid){t.splice(i,1);break}m.myCampus&&0<m.myCampus.length?m.anyService.selectedCampus=m.myCampus[0]:0==m.myCampus.length&&(m.anyService.selectedCampus=void 0),m.setCrudTabSelected(1),_suc(m,"Successfully deleted campus.")},function(e){ShowError(m,e,"Something went wrong. It's likely that everything related to the campus is deleted but please refresh to make sure or try again.",!0)})}else _err(m,"No Campus selected for deletion.")},m.addCampus=function(){var e='"name":"'+document.getElementById("CampusName").value+'"';0==document.getElementById("CampusDescription").value.localeCompare("")&&(document.getElementById("CampusDescription").value="-");var t='"description":"'+(t=document.getElementById("CampusDescription")).value+'"',o='"cuid":"'+(o=document.getElementById("CampusID")).value+'"',i=document.getElementById("Greeklish-OnOff").checked;i='"greeklish":"'+i+'"';var n=m.example9model.length;if(0!=n){for(var r='"buids":[',a=n-1;0<a;a--)r=r+'"'+m.example9model[a].id+'",';var l="{"+i+","+(r=r+'"'+m.example9model[0].id+'"]')+","+o+","+t+","+e+',"owner_id":"'+m.owner_id+'","access_token":"'+m.user.access_token+'"}';m.anyAPI.addBuildingSet(l).then(function(e){var t=e.data,o={};function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}o.name=document.getElementById("CampusName").value,o.buids=r.buids,o.description=document.getElementById("CampusDescription").value,o.cuid=t.cuid,m.myCampus.push(o),m.anyService.selectedCampus=m.myCampus[m.myCampus.length-1],_suc(m,"Successfully added campus.");var n=(i()+i()+"-"+i()+"-4"+i().substr(0,3)+"-"+i()+"-"+i()+i()+i()).toLowerCase(),a=new Date;document.getElementById("CampusID").value="cuid_"+n+"_"+a.getTime()},function(e){ShowError(m,e,"Something went wrong while adding the building.",!0)})}else _err(m,"No buildings selected.")};var a=new google.maps.OverlayView;if(a.draw=function(){},a.setMap(d.gmap),$("#draggable-building").draggable({helper:"clone",stop:function(e){var t=new google.maps.Point(e.pageX,e.pageY),o=a.getProjection().fromContainerPixelToLatLng(t);m.placeMarker(o)}}),m.placeMarker=function(e){var t=m.myMarkers[m.myMarkerId-1];if(t&&t.marker&&t.marker.getMap()&&t.marker.getDraggable())return _warn_autohide(m,"Finish adding the previous building.."),void LOG.D("there is a building pending, please add 1 at a time");var o={url:IMG_BUILDING_ARCHITECT,scaledSize:new google.maps.Size(50,50),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,0)},i=new google.maps.Marker({position:e,map:d.gmap,icon:o,draggable:!0}),n=new google.maps.InfoWindow({content:"-",maxWidth:500});m.$apply(function(){i.myId=m.myMarkerId,m.myMarkers[i.myId]={},m.myMarkers[i.myId].model={description:"",name:void 0,is_published:!0,address:"-",url:"-",bucode:"",type:void 0},m.myMarkers[i.myId].marker=i,m.myMarkers[i.myId].infowindow=n,m.myMarkerId++});var a='<form name="buildingForm" class="infowindow-scroll-fix"><fieldset class="form-group"><input ng-model="myMarkers['+i.myId+'].model.bucode" id="building-code" type="text" class="form-control" placeholder="Building Code (Optional)"/></fieldset><fieldset class="form-group"><input ng-model="myMarkers['+i.myId+'].model.name" id="building-name" type="text" class="form-control" placeholder="Building Name *"/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+i.myId+'].model.description" id="building-description" type="text" class="form-control" placeholder="Building Description (Optional)"></textarea></fieldset><fieldset class="form-group"><select ng-model="myMarkers['+i.myId+'].model.space_type" class="form-control" ng-options="type for type in spaceTypes" title="Space Types" tabindex="2"><option value="">Select Space Type</option></select></fieldset class="form-group"><fieldset class="form-group"><input ng-model="myMarkers['+i.myId+'].model.is_published" id="building-published" type="checkbox"><span> Make building public to view.</span></fieldset><fieldset class="form-group"></fieldset class="form-group"><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addNewBuilding('+i.myId+')"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempBuilding('+i.myId+')"><span class="glyphicon glyphicon-remove"></span></button></fieldset></div></form>',r='<div class="infowindow-scroll-fix"><h5 style="margin: 0">Building:</h5><span>{{myMarkers['+i.myId+'].model.name}}</span><h5 style="margin: 8px 0 0 0">Description:</h5><span>{{myMarkers['+i.myId+"].model.description}}</span></div>",l=s(a)(m);i.tpl2=s(r)(m),n.setContent(l[0]),n.open(d.gmap,i),google.maps.event.addListener(i,"click",function(){n.getMap()||n.open(d.gmap,i)})},m.deleteTempBuilding=function(e){var t=m.myMarkers[e];t&&t.marker&&t.marker.setMap(null)},m.exportBuildingToJson=function(){var c={building:{floors:[]}},p=m.anyService.selectedBuilding;if(LPUtils.isNullOrUndefined(p))_err(m,"No building selected");else{c.building.buid=p.buid,c.building.name=p.name,c.building.description=p.description,c.building.coordinates_lat=p.coordinates_lat,c.building.coordinates_lon=p.coordinates_lon;var e=g.jsonReq;e.buid=p.buid;var u=0;f.allBuildingFloors(e).then(function(e){var t,s=e.data.floors,d=[];if(s)for(var o=0;o<s.length;o++)t={buid:p.buid,floor_number:s[o].floor_number},f.retrievePoisByBuildingFloor(t).then(function(e){var t=e.data.pois;if(t){for(var o=[],i=t[0].floor_number,n=0;n<t.length;n++){var a=t[n];if("None"!=a.pois_type){if(a.overwrite)var r={name:a.name,description:a.description,puid:a.puid,pois_type:a.pois_type,coordinates_lat:a.coordinates_lat,coordinates_lon:a.coordinates_lon,overwrite:a.overwrite};else r={name:a.name,description:a.description,puid:a.puid,pois_type:a.pois_type,coordinates_lat:a.coordinates_lat,coordinates_lon:a.coordinates_lon,overwrite:"false"};o.push(r)}}if(d.push({floor_number:i,pois:o}),++u===s.length){c.building.floors=d,_suc(m,"Successfully exported "+p.name+" to JSON.");var l=new Blob([JSON.stringify(c,null,4)],{type:"text/plain;charset=utf-8"});saveAs(l,p.name.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")+".txt")}}},function(e){var t=e.data;console.log(t.message)})},function(e){console.log(e.data.message)})}},m.exportCampusToJson=function(){var e={campus:{buids:[]}},t=m.anyService.selectedCampus;if(LPUtils.isNullOrUndefined(t))_err("No campus selected");else{e.campus.name=t.name,e.campus.description=t.description,e.campus.buids=t.buids,_suc(m,"Successfully exported "+t.name+" to JSON.");var o=new Blob([JSON.stringify(e,null,4)],{type:"text/plain;charset=utf-8"});saveAs(o,t.name.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")+".txt")}},document.getElementById("file-input").addEventListener("change",function(e){var t=e.target.files[0];if(t){var o=new FileReader;o.onload=function(e){var t=e.target.result;m.fileToUpload=t},o.readAsText(t)}},!1),m.anyService.downloadlogfile=!1,m.importBuildingFromJson=function(){var e,t,o=m.anyService.progress=0,i=0;""==m.fileToUpload&&_err(m,"Something went wrong no file selected");var n=JSON.parse(m.fileToUpload);for(e=0;e<n.building.floors.length;e++)for(t=0;t<n.building.floors[e].pois.length;t++)"true"==n.building.floors[e].pois[t].overwrite&&o++;for(0==o&&_err(m,"Something went wrong no pois to update"),e=0;e<n.building.floors.length;e++)for(t=0;t<n.building.floors[e].pois.length;t++)"true"==n.building.floors[e].pois[t].overwrite&&(i++,m.updatePoifromFile(n.building.floors[e].pois[t].puid,n.building.floors[e].pois[t].coordinates_lat,n.building.floors[e].pois[t].coordinates_lon,n.building.floors[e].pois[t].name,n.building.floors[e].pois[t].description,n.building.floors[e].pois[t].pois_type,n.building.floors[e].pois[t].overwrite,n.building.buid,e,t,o,i,n.building.name))},m.allpois={},m.pois={},m.importBuildingFromExcel=function(e){m.anyService.progress=0;var t=document.getElementById("my_file_input").files[0];m.fileToUpload=t.name;var o=new FileReader;o.onload=function(e){var t=e.target.result,o=XLS.CFB.read(t,{type:"binary"}),i=XLS.parse_xlscfb(o);i.SheetNames.forEach(function(e){var t=XLS.utils.sheet_to_row_object_array(i.Sheets[e]);m.uploadloop(0,t,"")})},o.readAsBinaryString(t)},m.uploadloop=function(e,t,o){for(var i=e;i<t.length;i++){if(o!=t[i].buid&&null!=t[i].buid)return m.pois={},o=t[i].buid,void m.fetchAllPoisForBuilding(t[i].buid,t,i,o);var n="";null!=t[i].des3&&""!=t[i].des3&&null!=t[i].des3?null!=t[i].des4&&""!=t[i].des4&&null!=t[i].des4?n=n+t[i].des3+" "+t[i].des4:n+=t[i].des3:null!=t[i].des4&&""!=t[i].des4&&null!=t[i].des4&&(n+=t[i].des4),null!=t[i].des1&&""!=t[i].des1&&null!=t[i].des1&&(""!=n?n=n+"\n"+t[i].des1:n+=t[i].des1),null!=t[i].des2&&""!=t[i].des2&&null!=t[i].des2&&(""!=n?n=n+"\n"+t[i].des2:n+=t[i].des2),m.anyService.progress=i/(t.length-1)*100,t.length-1==0&&(m.anyService.progress=100),m.pois[t[i].name]?m.updatePoifromExcel(m.pois[t[i].name].puid,m.pois[t[i].name].coordinates_lat,m.pois[t[i].name].coordinates_lon,m.pois[t[i].name].is_building_entrance,t[i].name,n,m.pois[t[i].name].pois_type,m.pois[t[i].name].overwrite,m.pois[t[i].name].buid,""):m.updatePoifromExcel("","","","",t[i].name,n,"","","","")}},m.fetchAllPoisForBuilding=function(e,n,a,r){var t=g.jsonReq;t.buid=e,f.retrievePoisByBuilding(t).then(function(e){var t=e.data;m.myPois=t.pois;for(var o=m.myPois.length-1;0<=o;o--){var i=m.myPois[o].name;m.pois[i]=m.myPois[o]}m.uploadloop(a,n,r)},function(e){ShowError(m,e,"Something went wrong while fetching POIs",!0)})},m.logfile={pois:[]},m.updatePoifromExcel=function(o,e,t,i,n,a,r,l,s,d){var c={};c.coordinates_lat=e,c.coordinates_lon=t,c.is_building_entrance=i,c.name=n,c.puid=o,c.description=a,c.pois_type=r,c.overwrite="false",c.buid=s,m.anyAPI.updatePois(c).then(function(e){e.data;if(100==m.anyService.progress)if(m.anyService.downloadlogfile){m.anyService.downloadlogfile=!1,_suc(m,"Successfully updated POIs.A log file will be downloaded");var t=new Blob([JSON.stringify(m.logfile,null,4)],{type:"text/plain;charset=utf-8"});saveAs(t,(m.fileToUpload+"-log_file").toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")+".txt"),setTimeout(function(){m.anyService.progress=void 0},2500)}else _suc(m,"Successfully updated POIs."),setTimeout(function(){m.anyService.progress=void 0,location.reload()},2500)},function(e){e.data;if(m.logfile.pois.push({name:n,puid:o,description:a,status:"Something went wrong while updating POI."}),m.anyService.downloadlogfile=!0,100==m.anyService.progress){m.anyService.downloadlogfile=!1,_suc(m,"Successfully updated POIs.A log file will be downloaded");var t=new Blob([JSON.stringify(m.logfile,null,4)],{type:"text/plain;charset=utf-8"});saveAs(t,(m.fileToUpload+"-log_file").toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")+".txt"),m.logfile.pois=[],setTimeout(function(){m.anyService.progress=void 0},2500)}})},m.updatePoifromFile=function(o,e,t,i,n,a,r,l,s,d,c,p,u){var g={};g.coordinates_lat=e,g.coordinates_lon=t,g.name=i,g.puid=o,g.description=n,g.pois_type=a,g.overwrite="false",g.buid=l,m.anyAPI.updatePois(g).then(function(e){e.data;if(m.anyService.progress=p/c*100,100==m.anyService.progress)if(m.anyService.downloadlogfile){_suc(m,"Successfully updated POIs.A log file will be downloaded");var t=new Blob([JSON.stringify(m.logfile,null,4)],{type:"text/plain;charset=utf-8"});saveAs(t,(u+"-log_file").toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")+".txt"),setTimeout(function(){m.anyService.progress=void 0},2500)}else _suc(m,"Successfully updated POIs."),setTimeout(function(){m.anyService.progress=void 0,location.reload()},2500)},function(e){e.data;if(m.logfile.pois.push({name:i,puid:o,description:n,status:"Something went wrong while updating POI."}),m.anyService.downloadlogfile=!0,m.anyService.progress=p/c*100,100==m.anyService.progress)if(m.anyService.downloadlogfile){_suc(m,"Successfully updated POIs.A log file will be downloaded");var t=new Blob([JSON.stringify(m.logfile,null,4)],{type:"text/plain;charset=utf-8"});saveAs(t,(u+"-log_file").toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")+".txt"),m.logfile.pois=[],setTimeout(function(){m.anyService.progress=void 0},2500)}else _suc(m,"Successfully updated POIs."),setTimeout(function(){m.anyService.progress=void 0,location.reload()},2500)})},m.Poisresult={building:{floors:[]}},m.Connectionsresult={building:{}},m.zip=new JSZip,m.DownloadBackup=function(){var i=m.anyService.selectedBuilding,l=[],e=g.jsonReq;e.buid=i.buid,m.anyService.progress=0,f.allBuildingFloors(e).then(function(e){l=e.data.floors;for(var a="",t=0;t<l.length;t++)a=0==t?l[t].floor_number:a+" "+l[t].floor_number;m.anyService.progress=10;var r=i.buid,o=g.jsonReq;f.downloadFloorPlanAll(o,r,a).then(function(e){for(var t=e.data,o=m.zip.folder("floor_plans"),i=0;i<t.all_floors.length;i++)""!=t.all_floors[i]&&o.file(l[i].floor_number+".png",t.all_floors[i],{base64:!0});m.anyService.progress=25;var n=g.jsonReq;n.buid=r,n.floor=a,f.getRadioByBuildingFloorAll(n).then(function(e){var t=e.data,o=m.zip.folder("radiomaps");if(t.rss_log_files)for(var i=0;i<t.rss_log_files.length;i++)o.file(l[i].floor_number+"-radiomap.txt",t.rss_log_files[i]);m.anyService.progress=70,m.exportPoisBuildingToJson()},function(e){})},function(e){})},function(e){ShowError(m,e,ERR_FETCH_ALL_FLOORS,!0)})},m.exportPoisBuildingToJson=function(){var i=m.anyService.selectedBuilding;if(LPUtils.isNullOrUndefined(i))_err(m,"No building selected");else{m.Poisresult.building.buid=i.buid,m.Poisresult.building.name=i.name,m.Poisresult.building.description=i.description,m.Poisresult.building.coordinates_lat=i.coordinates_lat,m.Poisresult.building.coordinates_lon=i.coordinates_lon;var e=g.jsonReq;e.buid=i.buid;var d=0;f.allBuildingFloors(e).then(function(e){var t,l=e.data.floors,s=[];if(m.anyService.progress=80,l)for(var o=0;o<l.length;o++)t={buid:i.buid,floor_number:l[o].floor_number},f.retrievePoisByBuildingFloor(t).then(function(e){var t=e.data.pois;if(t){var o=[];if(null!=t[0]){for(var i=t[0].floor_number,n=0;n<t.length;n++){var a=t[n];if("None"!=a.pois_type){if(a.overwrite)var r={name:a.name,description:a.description,puid:a.puid,pois_type:a.pois_type,coordinates_lat:a.coordinates_lat,coordinates_lon:a.coordinates_lon,overwrite:a.overwrite};else r={name:a.name,description:a.description,puid:a.puid,pois_type:a.pois_type,coordinates_lat:a.coordinates_lat,coordinates_lon:a.coordinates_lon,overwrite:"false"};"true"==a.is_building_entrance?r.is_building_entrance="true":r.is_building_entrance="false",o.push(r)}}s.push({floor_number:i,pois:o})}++d===l.length&&(m.Poisresult.building.floors=s,m.zip.file("allpois.json",JSON.stringify(m.Poisresult,null,4)),m.anyService.progress=90,m.exportConnectionBuildingToJson())}},function(e){var t=e.data;console.log(t.message)})},function(e){console.log(e.data.message)})}},m.exportConnectionBuildingToJson=function(){var d=m.anyService.selectedBuilding;if(LPUtils.isNullOrUndefined(d))_err("No building selected");else{m.Connectionsresult.building.buid=d.buid,m.Connectionsresult.building.name=d.name,m.Connectionsresult.building.description=d.description,m.Connectionsresult.building.coordinates_lat=d.coordinates_lat,m.Connectionsresult.building.coordinates_lon=d.coordinates_lon;var e=g.jsonReq;e.buid=d.buid;var c=0;f.allBuildingFloors(e).then(function(e){var t,l=e.data.floors,s=[];if(l)for(var o=0;o<l.length;o++)t={buid:d.buid,floor_number:l[o].floor_number},f.retrieveConnectionsByBuildingFloor(t).then(function(e){m.anyService.progress=100;var t=e.data.connections;if(t){var o=[];if(null!=t[0]){for(var i=t[0].floor_a,n=0;n<t.length;n++){var a=t[n],r={name:a.name,description:a.description,cuid:a.puid,weight:a.weight,pois_a:a.pois_a,pois_b:a.pois_b,floor_a:a.floor_a,floor_b:a.floor_b,is_published:a.is_published,buid_a:a.buid_a,buid_b:a.buid_b};o.push(r)}s.push({floor_number:i,connections:o})}++c===l.length&&(m.Connectionsresult.building.floors=s,m.zip.file("allconnections.json",JSON.stringify(m.Connectionsresult,null,4)),m.zip.generateAsync({type:"blob"}).then(function(e){saveAs(e,d.buid+".zip")}),m.anyService.progress=void 0)}},function(e){var t=e.data;console.log(t.message)})},function(e){console.log(e.data.message)})}},$("#dismiss").on("click",function(){"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("dismissClicked","YES")}),"YES"!==localStorage.getItem("dismissClicked")){window.onload=function(){$("#myModal_Welcome").modal("show")}}}]),app.controller("ControlBarController",["$scope","$rootScope","AnyplaceService","GMapService","AnyplaceAPIService",function(i,e,t,n,o){i.anyService=t,i.gmapService=n,i.isAuthenticated=!1,i.creds={fullName:void 0,username:void 0,password:void 0},i.emptyUser={name:void 0,email:void 0,id:void 0,username:void 0,password:void 0,access_token:void 0},i.user=i.emptyUser;angular.element(document).ready(function(){null!=i.user&&null!=i.user.access_token||i.refreshLocalLogin()}),i.setAuthenticated=function(e){i.isAuthenticated=e},i.showFullControls=!0,i.toggleFullControls=function(){i.showFullControls=!i.showFullControls},i.copyApiKey=function(){LOG.W("Copying api key");var e=document.querySelector("#auth-api-key");e.focus(),e.select(),document.execCommand("copy"),_info(i,"API key copied!")},i.showGoogleID=function(){i.user.google&&t.addAlert("success","Google ID is: "+i.user.id)},i.showGoogleAuth=function(){i.user.access_token&&t.addAlert("success","access_token: "+i.user.access_token)},i.onSignIn=function(e){""===i.getCookie("reloadedAfterLogin")&&(i.setCookie("reloadedAfterLogin","true",365),location.reload()),i.setAuthenticated(!0),i.user=i.emptyUser,i.user.google={};var t=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse();LOG.D4("user.google.auth"),LOG.D4(t),i.googleUserLookup(e,t)},i.onSignInFailure=function(){LOG.E("Signin failed")},window.onSignIn=i.onSignIn,window.onSignInFailure=i.onSignInFailure,i.googleUserLookup=function(e,t){try{i.user.google=e.getBasicProfile()}catch(e){return void LOG.E("LOGIN error: "+e)}LOG.D4("googlePersonLookup"),LOG.D4(e),LOG.D4(t),i.user.google.auth=t,i.user.google.access_token=t.id_token,i.user.image=i.user.google.getImageUrl(),i.user.google._id=i.user.google.getId(),i.user.name=i.user.google.getName(),i.user.accountType="google",i.user.google.id=i.user.google._id+"_"+i.user.accountType,o.loginGoogle({name:i.user.name,external:"google",access_token:i.user.google.access_token}).then(function(e){var t=e.data;i.user.type=t.type,i.user.access_token=t.access_token,i.user.id=t.owner_id,app.user=i.user,i.user&&i.user.id&&i.$broadcast("loggedIn",[])},function(e){LOG.E("error: googleUserLookup"),LOG.D(e)})},i.refreshLocalLogin=function(){LOG.D3("refreshLocalLogin");var e={},t=i.getCookie("localAccessToken");""!==t&&(e.access_token=t,LOG.D2("Refreshing local login. token:"+t),o.refreshLocalAccount(e).then(function(e){var t=e.data;LOG.D4("refreshLocalLogin"),LOG.D4(e),i.user.username=t.user.username,i.user.name=t.user.name,i.user.email=t.user.email,i.user.id=t.user.owner_id,i.user.accountType="local",i.user.type=t.user.type,i.user.access_token=t.user.access_token,app.user=i.user,i.setAuthenticated(!0),i.user&&i.user.id&&i.$broadcast("loggedIn",[])},function(e){ShowError(i,e,"Login refresh failed.",!0),i.deleteCookie("localAccessToken")}))},i.loginWithLocalAccount=function(){var e={};LOG.D3("loginWithLocalAccount"),e.username=i.user.username,e.password=i.user.password,o.loginLocalAccount(e).then(function(e){var t=e.data;LOG.D4(e),i.user.username=t.user.username,i.user.name=t.user.name,i.user.email=t.user.email,i.user.id=t.user.owner_id,i.user.accountType="local",i.user.type=t.user.type,i.user.access_token=t.user.access_token,app.user=i.user,i.setAuthenticated(!0),""===i.getCookie("localAccessToken")&&i.setCookie("localAccessToken",i.user.access_token,30),i.user&&i.user.id&&i.$broadcast("loggedIn",[])},function(e){ShowError(i,e,"Login failed",!0),i.deleteCookie("localAccessToken")})},i.registerLocalAccount=function(){var e={};e.name=i.user.name,e.email=i.user.email,e.username=i.user.username,e.password=i.user.password,o.registerLocalAccount(e).then(function(e){e.data;_suc(i,"Successfully registered!")},function(e){ShowError(i,e,"Something went wrong at registration.",!0)})},i.signOut=function(){gapi.auth2.getAuthInstance().signOut().then(function(){LOG.D("User signed out.")}),i.isAuthenticated=!1,i.$broadcast("loggedOff",[]),i.user={},function(){if(void 0!==heatMap[0]&&null!==heatMap[0]){for(var e=heatMap.length;e--;)heatMap[e].rectangle.setMap(null),heatMap[e]=null;heatMap=[],document.getElementById("radioHeatmapRSS-mode").classList.remove("quickaction-selected"),_HEATMAP_FINGERPRINT_COVERAGE=!1,setColorClicked("g",!1),setColorClicked("y",!1),setColorClicked("o",!1),setColorClicked("p",!1),setColorClicked("r",!1),i.radioHeatmapRSSMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","NO"),i.anyService.radioHeatmapRSSMode=!1,i.radioHeatmapRSSHasGreen=!1,i.radioHeatmapRSSHasYellow=!1,i.radioHeatmapRSSHasOrange=!1,i.radioHeatmapRSSHasPurple=!1,i.radioHeatmapRSSHasRed=!1,$cookieStore.put("RSSClicked","NO")}}(),function(){if(void 0!==fingerPrintsMap[0]&&null!==fingerPrintsMap[0]){for(var e=fingerPrintsMap.length;e--;)fingerPrintsMap[e].setMap(null),fingerPrintsMap[e]=null;_FINGERPRINTS_IS_ON=!(fingerPrintsMap=[]),document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected")}if(heatmap&&heatmap.getMap()){heatmap.setMap(null),_FINGERPRINTS_IS_ON=!1,document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),_HEATMAP_F_IS_ON=!1;for(e=heatmapFingerprints.length;e--;)heatmapFingerprints[e]=null;heatmapFingerprints=[]}}(),i.deleteCookie("reloadedAfterLogin"),i.deleteCookie("localAccessToken")},i.getCookie=function(e){for(var t=e+"=",o=document.cookie.split(";"),i=0;i<o.length;i++){for(var n=o[i];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""},i.setCookie=function(e,t,o){var i=new Date;i.setTime(i.getTime()+24*o*60*60*1e3);var n="expires="+i.toUTCString();document.cookie=e+"="+t+"; "+n},i.deleteCookie=function(e){document.cookie=e+"=;expires="+new Date(0).toUTCString()},i.tab=1,i.setTab=function(e){i.tab=e},i.isTabSet=function(e){return i.tab===e},i.isAdmin=function(){return null!=i.user&&(null!=i.user.type&&("admin"==i.user.type||void 0))},i.isAdminOrModerator=function(){return null!=i.user&&(null!=i.user.type&&("admin"==i.user.type||"moderator"==i.user.type||void 0))};function a(e){i.anyService.addAlert("danger",e)}var r=void 0;i.userPosition=void 0;var l=!1;i.isUserLocVisible=!1,i.getIsUserLocVisible=function(){return i.isUserLocVisible},i.panToUserLocation=function(){i.userPosition&&(n.gmap.panTo(i.userPosition),n.gmap.setZoom(20))},i.displayMyLocMarker=function(e){r&&r.getMap()&&r.setPosition(e)},i.displayMyLocMarker=function(e){if(r&&r.getMap())r.setPosition(e);else{var t=new google.maps.Size(20,20);i.isFirefox&&(t=new google.maps.Size(48,48)),r=new google.maps.Marker({position:e,map:n.gmap,draggable:!1,icon:{url:"build/images/location-radius-centre.png",origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10),size:t,scaledSize:new google.maps.Size(20,20)}})}},i.hideUserLocation=function(){r&&r.setMap(null),i.isUserLocVisible=!1},i.showUserLocation=function(){if(i.getIsUserLocVisible())return i.hideUserLocation(),void(navigator.geolocation&&navigator.geolocation.clearWatch(watchPosNum));navigator.geolocation?watchPosNum=navigator.geolocation.watchPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude};i.userPosition=t,i.displayMyLocMarker(t);var o=new google.maps.InfoWindow({content:"Your current location.",maxWidth:500});google.maps.event.addListener(r,"click",function(){var e=this;i.$apply(function(){o.open(n.gmap,e)})}),i.isUserLocVisible||i.$apply(function(){i.isUserLocVisible=!0}),l||(n.gmap.panTo(t),n.gmap.setZoom(19),l=!0)},function(e){i.$apply(function(){HandleGeolocationError(i,e.code)})}):a(i,ERR_GEOLOC_NOT_SUPPORTED)},i.centerViewToSelectedItem=function(){if(null!=i.anyService.selectedBuilding&&null!=i.anyService.selectedBuilding){var e={};if(i.anyService.selectedPoi){var t=i.anyService.selectedPoi;e={lat:parseFloat(t.coordinates_lat),lng:parseFloat(t.coordinates_lon)}}else{if(!i.anyService.selectedBuilding)return void a(i);var o=i.anyService.selectedBuilding;e={lat:parseFloat(o.coordinates_lat),lng:parseFloat(o.coordinates_lon)}}i.gmapService.gmap.panTo(e),i.gmapService.gmap.setZoom(20)}else a(i)}}]);var changedfloor=!1;app.controller("FloorController",["$scope","AnyplaceService","GMapService","AnyplaceAPIService",function(l,s,d,i){var n;l.anyService=s,l.anyAPI=i,l.gmapService=d,l.xFloors=[],l.myFloors={},l.myFloorId=0,l.newFloorNumber=0,l.crudTabSelected=1,l.setCrudTabSelected=function(e){l.crudTabSelected=e},l.isCrudTabSelected=function(e){return l.crudTabSelected===e},l.data={floor_plan_coords:{},floor_plan_base64_data:{},floor_plan_groundOverlay:null},l.$on("loggedOff",function(e,t){o()});var o=function(){l.removeFloorPlan(),l.xFloors=[],l.myFloorId=0,l.myFloors={}};l.$watch("anyService.selectedBuilding",function(e,t){e&&(changedfloor=!1,l.fetchAllFloorsForBuilding(e))}),l.$watch("newFloorNumber",function(e,t){});l.$watch("anyService.selectedFloor",function(e,t){null==e||_.isEqual(e,t)||(l.fetchFloorPlanOverlay(e),d.gmap.panTo(function(e){if(e&&e.coordinates_lat&&e.coordinates_lon)return{lat:parseFloat(e.coordinates_lat),lng:parseFloat(e.coordinates_lon)}}(l.anyService.selectedBuilding)),d.gmap.setZoom(19),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastFloor",e.floor_number),changedfloor=!1)}),l.fetchAllFloorsForBuilding=function(e){var t=s.jsonReq;t.buid=e.buid,i.allBuildingFloors(t).then(function(e){if(l.xFloors=e.data.floors,l.xFloors=l.xFloors.sort(function(e,t){return parseInt(e.floor_number)-parseInt(t.floor_number)}),l.anyService.availableFloors=[],l.anyService.availableFloors=l.xFloors,l.urlFloor)for(var t=0;t<l.xFloors.length;t++)if(l.urlFloor==l.xFloors[t].floor_number)return void(l.anyService.selectedFloor=l.xFloors[t]);if("undefined"!=typeof Storage&&localStorage&&!LPUtils.isNullOrUndefined(localStorage.getItem("lastBuilding"))&&!LPUtils.isNullOrUndefined(localStorage.getItem("lastFloor")))for(var o=0;o<l.xFloors.length;o++)if(String(l.xFloors[o].floor_number)===String(localStorage.getItem("lastFloor")))return void(l.anyService.selectedFloor=l.xFloors[o]);l.xFloors&&0<l.xFloors.length?l.anyService.selectedFloor=l.xFloors[0]:l.anyService.selectedFloor=void 0,a()},function(e){ShowError(l,e,ERR_FETCH_ALL_FLOORS,!0)})};var a=function(){for(var e=-1,t=0;t<l.xFloors.length;t++)parseInt(l.xFloors[t].floor_number)>=e&&(e=parseInt(l.xFloors[t].floor_number));l.newFloorNumber=e+1};l.fetchFloorPlanOverlay=function(){if(null===(e=this.anyService.selectedFloor)||null==e||null===e.floor_number||void 0===e.floor_number)return _warn_autohide(l,"Something is wrong with the floor"),void console.log("Something is wrong with the floor");var e,t=this.anyService.selectedFloor.floor_number,o=this.anyService.selectedBuilding.buid;i.downloadFloorPlan(this.anyService.jsonReq,o,t).then(function(e){l.data.floor_plan_file=null,(l.data.floor_plan=null)!=l.data.floor_plan_groundOverlay&&(l.data.floor_plan_groundOverlay.setMap(null),l.data.floor_plan_groundOverlay=null);var t=e.data,o=l.anyService.selectedFloor,i=new google.maps.LatLngBounds(new google.maps.LatLng(o.bottom_left_lat,o.bottom_left_lng),new google.maps.LatLng(o.top_right_lat,o.top_right_lng));l.data.floor_plan_groundOverlay=new USGSOverlay(i,"data:image/png;base64,"+t,d.gmap)},function(e){ShowWarningAutohide(l,e,"Error downloading floor plan")})};var c=null;l.isCanvasOverlayActive=!1,$("#input-floor-plan").change(function(e){var t=new FileReader;t.onload=function(e){var t=new Image;t.src=e.target.result,t.onload=function(){c=new CanvasOverlay(t,d.gmap),l.$apply(l.isCanvasOverlayActive=!0),l.data.floor_plan_groundOverlay&&l.data.floor_plan_groundOverlay.getMap()&&l.data.floor_plan_groundOverlay.setMap(null)}},t.readAsDataURL(e.target.files[0]),this.disabled=!0}),l.setFloorPlan=function(){if(c)if(d.gmap.getZoom()<20)_err(l,"Minimum zoom level required: 20. Current: "+d.gmap.getZoom());else{if(null===s.getBuildingId()||void 0===s.getBuildingId())return console.log("building is undefined"),void _err(l,"Something went wrong. Have you selected a building?");var e={is_published:"true",buid:String(s.getBuildingId()),floor_name:String(l.newFloorNumber),description:String(l.newFloorNumber),floor_number:String(l.newFloorNumber)};l.myFloors[l.myFloorId]=e,l.myFloorId++,c.drawBoundingCanvas();var t=c.bottom_left_coords,o=c.top_right_coords;l.data.floor_plan_coords.bottom_left_lat=t.lat(),l.data.floor_plan_coords.bottom_left_lng=t.lng(),l.data.floor_plan_coords.top_right_lat=o.lat(),l.data.floor_plan_coords.top_right_lng=o.lng(),l.data.floor_plan_coords.zoom=d.gmap.getZoom()+"";var i=c.getCanvas().toDataURL("image/png");l.data.floor_plan_base64_data=i;var n=new google.maps.LatLngBounds(new google.maps.LatLng(t.lat(),t.lng()),new google.maps.LatLng(o.lat(),o.lng()));if(l.data.floor_plan_groundOverlay=new USGSOverlay(n,i,d.gmap),c.setMap(null),$("#input-floor-plan").prop("disabled",!1),l.isCanvasOverlayActive=!1,p(l.newFloorNumber))for(var a=0;a<l.xFloors.length;a++){var r=l.xFloors[a];if(!LPUtils.isNullOrUndefined(r)&&r.floor_number===String(l.newFloorNumber)){l.uploadWithZoom(l.anyService.selectedBuilding,r,l.data);break}}else l.addFloorObject(e,l.anyService.selectedBuilding,l.data)}};l.addFloorObject=function(e,t,o){var i,n=(i=null===(i=e)?{}:JSON.parse(JSON.stringify(i)),LPUtils.isNullOrUndefined(i.buid)&&(i.buid=""),LPUtils.isNullOrUndefined(i.floor_name)&&(i.floor_name=""),LPUtils.isNullOrUndefined(i.floor_number)&&(i.floor_number=""),LPUtils.isNullOrUndefined(i.description)&&(i.description=""),LPUtils.isNullOrUndefined(i.is_published)&&(i.is_published="true"),i);l.anyAPI.addFloor(n).then(function(e){e.data;l.xFloors.push(n),l.anyService.selectedFloor=l.xFloors[l.xFloors.length-1],_suc(l,"Successfully added new floor"),l.uploadWithZoom(t,n,o)},function(e){ShowError(l,e,"Something went wrong while adding a new floor.",!0)})},l.removeFloorPlan=function(){l.data.floor_plan_file=null,l.data.floor_plan=null,c&&c.setMap(null),l.data.floor_plan_groundOverlay&&l.data.floor_plan_groundOverlay.setMap(null);var e=$("#input-floor-plan");e.replaceWith(e=e.clone(!0)),e.prop("disabled",!1),l.isCanvasOverlayActive=!1},l.deleteFloor=function(){var n=l.anyService.getFloor();LPUtils.isNullOrUndefined(n)||LPUtils.isStringBlankNullUndefined(n.floor_number)||LPUtils.isStringBlankNullUndefined(n.buid)?_err(l,"No floor seems to be selected."):l.anyAPI.deleteFloor(n).then(function(e){e.data;for(var t=l.xFloors,o=t.length,i=0;i<o;i++)if(t[i].floor_number==n.floor_number){t.splice(i,1);break}null!=l.data.floor_plan_groundOverlay&&(l.data.floor_plan_groundOverlay.setMap(null),l.data.floor_plan_groundOverlay=null),l.xFloors&&0<l.xFloors.length?l.anyService.selectedFloor=l.xFloors[0]:l.anyService.selectedFloor=void 0,_suc(l,"Successfully deleted floor.")},function(e){ShowError(l,e,"Something went wrong while deleting the floor.",!0)})};var p=function(e){for(var t=0;t<l.xFloors.length;t++){var o=l.xFloors[t];if(!LPUtils.isNullOrUndefined(o)&&o.floor_number===String(e))return!0}return!1};l.uploadWithZoom=function(e,t,o){if(!LPUtils.isNullOrUndefined(c)){var i,n=(i=o.floor_plan_coords,LPUtils.isNullOrUndefined(i)?{}:JSON.parse(JSON.stringify(i)));if(LPUtils.isNullOrUndefined(n)||LPUtils.isStringBlankNullUndefined(n.bottom_left_lat)||LPUtils.isStringBlankNullUndefined(n.bottom_left_lng)||LPUtils.isStringBlankNullUndefined(n.top_right_lat)||LPUtils.isStringBlankNullUndefined(n.top_right_lng))return console.log("error with floor coords"),void _err(l,"Something went wrong. It seems like no valid coordinates have been set up for this floor plan.");if(n.bottom_left_lat=String(n.bottom_left_lat),n.bottom_left_lng=String(n.bottom_left_lng),n.top_right_lat=String(n.top_right_lat),n.top_right_lng=String(n.top_right_lng),t.bottom_left_lat=n.bottom_left_lat,t.bottom_left_lng=n.bottom_left_lng,t.top_right_lat=n.top_right_lat,t.top_right_lng=n.top_right_lng,LPUtils.isNullOrUndefined(e))_err(l,"Something went wrong. It seems like there is no building selected.");else if(LPUtils.isNullOrUndefined(e.buid))_err(l,"Something went wrong with the selected building's id.");else if(n.buid=e.buid,LPUtils.isNullOrUndefined(t))_err(l,"Something went wrong. It seems there is no floor selected.");else if(LPUtils.isNullOrUndefined(t.floor_number))_err(l,"Something went wrong. It seems there is no floor number associated with the selected floor.");else{n.floor_number=t.floor_number,n.owner_id=l.owner_id;var a=JSON.stringify(n);if(LPUtils.isNullOrUndefined(o.floor_plan_base64_data)||LPUtils.isStringEmptyNullUndefined(o.floor_plan_base64_data))console.log("no floor plan file");else l.anyAPI.uploadFloorPlan64(a,l.data.floor_plan_base64_data).then(function(e){e.data;_suc(l,"Successfully uploaded new floor plan.")},function(e){e.data;_suc(l,"Successfully uploaded new floor plan.")})}}},l.showRadioHeatmapPoi=function(){var e={buid:l.anyService.getBuildingId(),floor:l.anyService.getFloorNumber(),coordinates_lat:l.anyService.selectedPoi.coordinates_lat,coordinates_lon:l.anyService.selectedPoi.coordinates_lon,range:"1"};e.username=l.creds.username,e.password=l.creds.password,l.anyAPI.getRadioHeatmapPoi(e).then(function(e){e.data;var t=[],o=e.data.radioPoints.length;if(o<=0)_err(l,"This floor seems not to be WiFi mapped. Download the Anyplace app from the Google Play store to map the floor.");else{for(;o--;){var i=e.data.radioPoints[o];t.push({location:new google.maps.LatLng(i.x,i.y),weight:1}),e.data.radioPoints.splice(o,1)}n&&n.getMap()&&n.setMap(null),(n=new google.maps.visualization.HeatmapLayer({data:t})).setMap(l.gmapService.gmap)}},function(e){ShowError(l,e,"Something went wrong while fetching radio heatmap.",!0)})}}]),app.controller("PoiController",["$scope","$compile","GMapService","AnyplaceService","AnyplaceAPIService",function(u,g,m,f,o){_POIS_IS_ON=_CONNECTIONS_IS_ON=!0,u.anyService=f,u.anyAPI=o,u.myMarkers={},u.myMarkerId=0,u.myPaths={},u.myPathId=0,u.myPois=[],u.myPoisHashT={},u.myConnectionsHashT={},u.edgeMode=!1,u.connectPois={prev:void 0,next:void 0},u.crudTabSelected=1,u.setCrudTabSelected=function(e){u.crudTabSelected=e},u.isCrudTabSelected=function(e){return u.crudTabSelected===e},u.orderByName=function(e){return e.name},u.$on("loggedOff",function(e,t){u.clearConnectionsOnMap(),u.clearPoisOnMap(),u.myPaths={},u.myPathId=0,u.myMarkers={},u.myMarkerId=0,u.myPois=[],u.myPoisHashT={},u.myConnectionsHashT={},u.anyService.setAllPois(u.myPoisHashT),u.anyService.setAllConnection(u.myConnectionsHashT),u.edgeMode=!1,u.connectPois={prev:void 0,next:void 0}}),u.$watch("anyService.selectedBuilding",function(e,t){u.poisTypes=["Disabled Toilets","Elevator","Entrance","Fire Extinguisher","First Aid/AED","Kitchen","Office","Ramp","Room","Security/Guard","Stair","Toilets","Other"],u.poicategories=[{poicat:"Disabled Toilets",poicatPlaceholder:"name",id:"type1",disenable:"false"},{poicat:"Elevator",poicatPlaceholder:"name",id:"type2",disenable:"true"},{poicat:"Entrance",poicatPlaceholder:"name",id:"type3",disenable:"true"},{poicat:"Fire Extinguisher",poicatPlaceholder:"name",id:"type4",disenable:"false"},{poicat:"First Aid/AED",poicatPlaceholder:"name",id:"type5",disenable:"false"},{poicat:"Kitchen",poicatPlaceholder:"name",id:"type6",disenable:"false"},{poicat:"Office",poicatPlaceholder:"name",id:"type7",disenable:"false"},{poicat:"Ramp",poicatPlaceholder:"name",id:"type8",disenable:"false"},{poicat:"Room",poicatPlaceholder:"name",id:"type9",disenable:"false"},{poicat:"Security/Guard",poicatPlaceholder:"name",id:"type10",disenable:"false"},{poicat:"Stair",poicatPlaceholder:"name",id:"type11",disenable:"true"},{poicat:"Toilets",poicatPlaceholder:"name",id:"type12",disenable:"false"},{poicat:"Other",poicatPlaceholder:"name",id:"type13",disenable:"false"}]}),u.$watch("anyService.selectedFloor",function(e,t){null==e||_.isEqual(e,t)?u.anyService.selectedPoi=void 0:u.fetchAllPoisForFloor(e)}),u.$watch("anyService.selectedPoi",function(e,t){if(e&&c(e)&&e&&(m.gmap.panTo(c(e)),e.puid)){var o=u.myPoisHashT[e.puid].marker;o&&o.infowindow&&o.tpl2&&(o.infowindow.setContent(o.tpl2[0]),o.infowindow.open(m.gmap,o)),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastPoi",e.puid)}}),u.add=function(){""!=u.poicategories[u.poicategories.length-1].poicat?u.poicategories.push({poicat:"",poicatPlaceholder:"name",disenable:"false"}):_err(u,"Complete the last input to continue!")},u.deletetype=function(e){for(var t=0;t<u.poicategories.length;t++)if(u.poicategories[t].id==e){u.poicategories[t].id="",$("#".id).remove();break}},u.onInfoWindowKeyDown=function(e){if(27==e.keyCode&&u.anyService.selectedPoi){var t=u.anyService.selectedPoi;u.myPoisHashT[t.puid]&&u.myPoisHashT[t.puid].marker&&u.myPoisHashT[t.puid].marker.infowindow&&(u.myPoisHashT[t.puid].marker.infowindow.setMap(null),u.anyService.setAllPois(u.myPoisHashT))}},u.clearPoisOnMap=function(){for(var e=0;e<u.myPois.length;e++){var t=u.myPois[e];t&&u.myPoisHashT[t.puid]&&u.myPoisHashT[t.puid].marker&&(u.myPoisHashT[t.puid].marker.setMap(null),delete u.myPoisHashT[t.puid])}u.myPoisHashT={},u.anyService.setAllPois(u.myPoisHashT)},u.clearConnectionsOnMap=function(){if(u.myConnectionsHashT){for(var e in u.myConnectionsHashT)e&&u.myConnectionsHashT.hasOwnProperty(e)&&u.myConnectionsHashT[e]&&u.myConnectionsHashT[e].polyLine&&(u.myConnectionsHashT[e].polyLine.setMap(null),delete u.myConnectionsHashT[e]);u.myConnectionsHashT={},u.anyService.setAllConnection(u.myConnectionsHashT)}},u.fetchConnections=function(){var e,t,o=u.anyService.jsonReq,i=u.anyService.getBuilding();if(LPUtils.isNullOrUndefined(i))_err(u,"No building has been selected!");else if(LPUtils.isNullOrUndefined(i.buid))_err(u,"No valid building has been selected!");else{e=u.anyService.getBuildingId();var n=u.anyService.getFloor();if(LPUtils.isNullOrUndefined(n))_err(u,"No floor has been selected!");else if(LPUtils.isNullOrUndefined(n.floor_number))_err(u,"No valid floor has been selected!");else if(t=u.anyService.getFloorNumber(),o.buid=e,o.floor_number=t,(LPUtils.isNullOrUndefined(u.myPois)||LPUtils.isNullOrUndefined(u.myPoisHashT))&&_err(u,"Please load the POIs of this floor first."),0!=u.myPois.length){var a=o;u.anyAPI.retrieveConnectionsByBuildingFloor(a).then(function(e){var t=e.data;u.clearConnectionsOnMap();for(var o=t.connections,i={},n=o.length,a=0;a<n;a++)i[o[a].cuid]=o[a];u.myConnectionsHashT=i,u.anyService.setAllConnection(u.myConnectionsHashT),u.drawConnectionsOnMap()},function(e){ShowError(u,e,"Something went wrong while loading the POI connections",!0)})}}},u.drawConnectionsOnMap=function(){for(var e in u.myConnectionsHashT)if(u.myConnectionsHashT.hasOwnProperty(e)){var t=u.myConnectionsHashT[e];if(!(t&&t.pois_a&&t.pois_b&&u.myPoisHashT[t.pois_a]&&u.myPoisHashT[t.pois_b]&&u.myPoisHashT[t.pois_a].model&&u.myPoisHashT[t.pois_b].model))continue;var o=[new google.maps.LatLng(u.myPoisHashT[t.pois_a].model.coordinates_lat,u.myPoisHashT[t.pois_a].model.coordinates_lon),new google.maps.LatLng(u.myPoisHashT[t.pois_b].model.coordinates_lat,u.myPoisHashT[t.pois_b].model.coordinates_lon)],i=new google.maps.Polyline({path:o,strokeColor:"#0000FF",strokeOpacity:.5,strokeWeight:4});_CONNECTIONS_IS_ON&&i.setMap(m.gmap),i.model=t,u.myConnectionsHashT[e].polyLine=i,u.anyService.setAllConnection(u.myConnectionsHashT),google.maps.event.addListener(i,"click",function(){u.$apply(S(this)),u.anyService.setAllConnection(u.myConnectionsHashT)})}};function i(e){var t=e.lat(),o=e.lng(),i=u.anyService.getFloor();if(LPUtils.isNullOrUndefined(i))return _err(u,"No selected floor found."),0;var n=i.top_right_lat,a=i.top_right_lng,r=i.bottom_left_lat,l=i.bottom_left_lng;return n&&a&&r&&l?t<=parseFloat(n)+.001&&o<=parseFloat(a)+.001&&t>=parseFloat(r)-.001&&o>=parseFloat(l)-.001:(_err(u,"Floor coordinates not found."),!1)}var d="build/images/edge-connector.png",e="build/images/poi.png",c=function(e){if(e&&e.coordinates_lat&&e.coordinates_lon)return{lat:parseFloat(e.coordinates_lat),lng:parseFloat(e.coordinates_lon)}};u.drawPoisOnMap=function(){var a=new google.maps.InfoWindow({content:"-",maxWidth:500}),e=void 0,t=-1;"undefined"==typeof Storage||!localStorage||LPUtils.isNullOrUndefined(localStorage.getItem("lastBuilding"))||LPUtils.isNullOrUndefined(localStorage.getItem("lastFloor"))||LPUtils.isNullOrUndefined(localStorage.getItem("lastPoi"))||(e=localStorage.getItem("lastPoi"));for(var o=0;o<u.myPois.length;o++){u.myPois[o].pois_type2=u.myPois[o].pois_type;var i,n=u.myPois[o];e&&n.puid===e&&(t=o);var r="-";if(n.pois_type2=n.pois_type,"None"==n.pois_type)i=new google.maps.Marker({position:c(n),draggable:!0,icon:new google.maps.MarkerImage(d,null,null,new google.maps.Point(11,11),new google.maps.Size(21,21))}),_POIS_IS_ON&&i.setMap(m.gmap),r='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><div class="infowindow-title">Connector</div><input value="'+n.puid+'" type="text" class="form-control input-tiny" onClick="selectAllInputText(this)" readonly/><br><fieldset class="form-group" style="display: inline-block; width: 73%;"><button type="submit" class="btn btn-success add-any-button" ng-click="updatePoi(\''+n.puid+'\')"><span class="glyphicon glyphicon-pencil"></span> Update</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi(\''+n.puid+'\')"><i class="fa fa-trash text-white"></i></button></fieldset></div>';else{var l=new google.maps.Size(32,32);i=new google.maps.Marker({position:c(n),draggable:!0,icon:new google.maps.MarkerImage("build/images/poi.png",null,null,null,l)}),_POIS_IS_ON&&i.setMap(m.gmap),r='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm" class="mapForm"><div class="infowindow-title">POI</div><input ng-model="myPois['+o+'].puid" type="text" class="form-control input-tiny" onClick="selectAllInputText(this)" readonly/><br><fieldset class="form-group"><textarea ng-model="myPois['+o+'].name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus></textarea></fieldset><fieldset class="form-group"><textarea ng-model="myPois['+o+'].description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><div>POI Type:</div><select ng-model="myPois['+o+'].pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">POI Type</option></select></fieldset class="form-group"><fieldset class="form-group"><div>Custom type:</div><input ng-model="myPois['+o+'].pois_type2" id="poi-pois_type2" type="text" class="form-control" placeholder="POI Type" tabindex="2"></fieldset><fieldset class="form-group"><input ng-model="myPois['+o+'].is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="updatePoi(\''+n.puid+'\')" tabindex="3"><span class="glyphicon glyphicon-pencil"></span> Update</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi(\''+n.puid+'\')" tabindex="6"><i class="fa fa-trash text-white"></i></button></fieldset></div></form></div>'}var s=g(r)(u);i.tpl2=s,i.model=n,i.infowindow=a,u.myPoisHashT[n.puid].marker=i,u.anyService.setAllPois(u.myPoisHashT),google.maps.event.addListener(i,"click",function(){if(u.edgeMode)if(u.connectPois.prev){if(u.connectPois.prev==this)return u.connectPois.prev=void 0,void("None"===this.model.pois_type?this.setIcon(h()):this.setIcon(P()));"None"===u.connectPois.prev.model.pois_type?u.connectPois.prev.setIcon(h()):u.connectPois.prev.setIcon(P());var i=new google.maps.Polyline({path:[this.position,u.connectPois.prev.position],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:.5,strokeWeight:4});i.setMap(m.gmap);var e=u.connectPois.prev.model,t=this.model;if(!e||!t||!e.puid||!t.puid||!e.buid||!t.buid||LPUtils.isNullOrUndefined(e.floor_number)||LPUtils.isNullOrUndefined(t.floor_number))return void _err(u,"One or both of the POIs attempted to be connected seem to be be malformed. Please refresh.");var o={owner_id:u.owner_id,pois_a:e.puid,floor_a:e.floor_number,buid_a:e.buid,buid:e.buid,pois_b:t.puid,floor_b:t.floor_number,buid_b:t.buid,is_published:"true",edge_type:"hallway"};i.model=o,u.anyAPI.addConnection(o).then(function(e){var t=e.data.cuid;i.model.cuid=t;var o=i.model;o.polyLine=i,u.myConnectionsHashT[t]=o,u.anyService.setAllConnection(u.myConnectionsHashT),i.setOptions({strokeColor:"#503C8E",strokeOpacity:.7}),google.maps.event.addListener(i,"click",function(){u.$apply(S(this))})},function(e){ShowError(u,e,"Something went wrong while attempting to connect the two POIs.",!0),i.setMap(null)}),u.connectPois.prev=void 0}else"None"===(u.connectPois.prev=this).model.pois_type?this.setIcon(p()):this.setIcon(y());else{a.setContent(this.tpl2[0]),a.open(m.gmap,this);var n=this;u.$apply(function(){n.model&&n.model.puid&&(u.anyService.selectedPoi=n.model)})}}),google.maps.event.addListener(i,"dragend",function(e){this.model&&this.model.puid&&u.updatePoiPosition(this)})}0<=t&&(u.anyService.selectedPoi=u.myPois[t]),u.fetchConnections()};var p=function(){return new google.maps.MarkerImage(d,null,null,null,new google.maps.Size(41,41))},h=function(){return new google.maps.MarkerImage(d,null,null,null,new google.maps.Size(21,21))},y=function(){return new google.maps.MarkerImage(e,null,null,null,new google.maps.Size(31,48))},P=function(){return new google.maps.MarkerImage(e,null,null,null,new google.maps.Size(21,32))},S=function(t){if(u.edgeMode)if(t&&t.model&&t.model.cuid){var e=t.model,o=t.model.cuid;if(u.myConnectionsHashT[o]){var i,n=(null===(i=e)&&(i={}),LPUtils.isNullOrUndefined(i.buid)&&(i.buid=""),LPUtils.isNullOrUndefined(i.is_published)&&(i.is_published=!1),LPUtils.isNullOrUndefined(i.edge_type)&&(i.edge_type=""),LPUtils.isNullOrUndefined(i.pois_a)&&(i.pois_a=""),LPUtils.isNullOrUndefined(i.pois_b)&&(i.pois_b=""),LPUtils.isNullOrUndefined(i.floor_a)&&(i.floor_a=""),LPUtils.isNullOrUndefined(i.floor_b)&&(i.floor_b=""),LPUtils.isNullOrUndefined(i.buid_a)&&(i.buid_a=""),LPUtils.isNullOrUndefined(i.buid_b)&&(i.buid_b=""),i);if(LPUtils.isNullOrUndefined(n.pois_a)||LPUtils.isStringBlankNullUndefined(n.pois_a))_err(u,"No valid connection has been selected. Missing POI A.");else if(LPUtils.isNullOrUndefined(n.pois_b)||LPUtils.isStringBlankNullUndefined(n.pois_b))_err(u,"No valid connection has been selected. Missing POI B.");else{t.setMap(null);var a=t.model.polyLine;delete t.model.polyLine,u.anyAPI.deleteConnection(n).then(function(e){e.data;delete u.myConnectionsHashT[o],u.anyService.setAllConnection(u.myConnectionsHashT)},function(e){t.setMap(m.gmap),t.model.polyLine=a,ShowError(u,e,"Something went wrong. Connection could not be deleted.",!0)})}}else _err(u,"The connection attempted to delete does not exist in the system.")}else _err(u,"No valid connection selected.");else _info(u,'Enable "Edge Mode" so you can delete connections by clicking on them.')};u.fetchAllPoisForFloor=function(e){var t=f.jsonReq;t.buid=f.getBuildingId(),t.floor_number=f.getFloorNumber(),o.retrievePoisByBuildingFloor(t).then(function(e){var t=e.data;u.clearPoisOnMap(),u.myPois=t.pois;for(var o=u.myPois.length-1;0<=o;o--){var i=u.myPois[o].puid;"true"==u.myPois[o].is_building_entrance?u.myPois[o].is_building_entrance=!0:u.myPois[o].is_building_entrance=!1,u.myPois[o].pois_type2=u.myPois[o].pois_type,u.myPoisHashT[i]={},u.myPoisHashT[i].model=u.myPois[o],u.anyService.setAllPois(u.myPoisHashT)}u.drawPoisOnMap()},function(e){ShowError(u,e,"Something went wrong while fetching POIs",!0)})};var n=new google.maps.OverlayView;n.draw=function(){},n.setMap(m.gmap),u.addPoi=function(o){if(u.myMarkers[o]&&u.myMarkers[o].marker){0!=u.myMarkers[o].model.pois_type2.localeCompare("")&&(u.myMarkers[o].model.pois_type=u.myMarkers[o].model.pois_type2);var i=u.myMarkers[o].model;if(i.coordinates_lat=String(u.myMarkers[o].marker.position.lat()),i.coordinates_lon=String(u.myMarkers[o].marker.position.lng()),i.is_building_entrance=String(i.is_building_entrance),void 0===i.coordinates_lat||null===i.coordinates_lat)return void _err(u,"POI has invalid latitude format");if(void 0===i.coordinates_lon||null===i.coordinates_lon)return void _err(u,"POI has invalid longitude format");if(!(i.name&&i.buid&&i.pois_type)||LPUtils.isNullOrUndefined(i.is_building_entrance)||LPUtils.isNullOrUndefined(i.is_published)||LPUtils.isNullOrUndefined(i.is_door)||LPUtils.isNullOrUndefined(i.floor_name)||LPUtils.isNullOrUndefined(i.floor_number))_err(u,"Cannot add new POI. Some required fields are missing.");else{"true"==i.is_building_entrance?i.is_building_entrance="true":i.is_building_entrance="false";var e=i;u.anyAPI.addPois(e).then(function(e){var t=e.data;i.puid=t.puid,"true"==i.is_building_entrance?i.is_building_entrance=!0:i.is_building_entrance=!1,u.myPois.push(i),u.anyService.selectedPoi=u.myPois[u.myPois.length-1],u.myPoisHashT[i.puid]={model:i,marker:u.myMarkers[o].marker},u.anyService.setAllPois(u.myPoisHashT),u.myMarkers[o].model=i,u.myMarkers[o].infowindow&&(u.myMarkers[o].infowindow.close(),u.myMarkers[o].infowindow.setContent(u.myMarkers[o].marker.tpl2[0])),u.myMarkers[o].marker.model=i,"None"==u.myMarkers[o].marker.model.pois_type?u.myMarkers[o].marker.setIcon(h()):u.myMarkers[o].marker.setIcon(P()),google.maps.event.clearListeners(u.myMarkers[o].marker,"click");var a=u.myMarkers[o].infowindow;google.maps.event.addListener(u.myMarkers[o].marker,"click",function(){if(u.edgeMode)if(u.connectPois.prev){if(u.connectPois.prev==this)return u.connectPois.prev=void 0,void("None"===this.model.pois_type?this.setIcon(h()):this.setIcon(P()));"None"===u.connectPois.prev.model.pois_type?u.connectPois.prev.setIcon(h()):u.connectPois.prev.setIcon(P());var i=new google.maps.Polyline({path:[this.position,u.connectPois.prev.position],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:.5,strokeWeight:4});i.setMap(m.gmap);var e=u.connectPois.prev.model,t=this.model;if(!e||!t||!e.puid||!t.puid||!e.buid||!t.buid||LPUtils.isNullOrUndefined(e.floor_number)||LPUtils.isNullOrUndefined(t.floor_number))return void _err(u,"One or both of the POIs attempted to be connected seem to be be malformed. Please refresh.");var o={pois_a:e.puid,floor_a:e.floor_number,buid_a:e.buid,buid:e.buid,pois_b:t.puid,floor_b:t.floor_number,buid_b:t.buid,is_published:"true",edge_type:"hallway"};i.model=o,u.anyAPI.addConnection(o).then(function(e){var t=e.data.cuid;i.model.cuid=t;var o=i.model;o.polyLine=i,u.myConnectionsHashT[t]=o,u.anyService.setAllConnection(u.myConnectionsHashT),i.setOptions({strokeColor:"#0000FF",strokeOpacity:.5}),google.maps.event.addListener(i,"click",function(){u.$apply(S(this))})},function(e){ShowError(u,e,"Something went wrong while attempting to connect the two POIs.",!0),i.setMap(null)}),u.connectPois.prev=void 0}else"None"===(u.connectPois.prev=this).model.pois_type?this.setIcon(p()):this.setIcon(y());else{a.setContent(this.tpl2[0]),a.open(m.gmap,this);var n=this;u.$apply(function(){n.model&&n.model.puid&&(u.anyService.selectedPoi=n.model)})}}),google.maps.event.addListener(u.myMarkers[o].marker,"dragend",function(e){this.model&&this.model.puid&&u.updatePoiPosition(this)})},function(e){ShowError(u,e,"Something went wrong while adding the new POI.",!0)})}}},u.deletePoi=function(e){var t,o=u.myPoisHashT[e];if(!o||!o.model||!o.model.puid){if(!(u.myPoisHashT&&u.myMarkers&&u.myMarkers[e]&&u.myMarkers[e].model&&u.myPoisHashT[u.myMarkers[e].model.puid]))return void _err(u,"No valid POI selected to be deleted.");if(!(o=u.myPoisHashT[u.myMarkers[e].model.puid])||!o.model||!o.model.puid)return void _err(u,"No valid POI selected to be deleted.")}var i=u.myConnectionsHashT;for(var n in i)if(i.hasOwnProperty(n)&&((t=i[n]).pois_a==o.model.puid||t.pois_b==o.model.puid))return void _err(u,"Please delete all the connections attached to this POI first.");var a=o.model,r=a.puid;!0===a.is_building_entrance||"true"===a.is_building_entrance?a.is_building_entrance="true":a.is_building_entrance="false",u.anyAPI.deletePois(a).then(function(e){e.data;"true"===a.is_building_entrance?a.is_building_entrance=!0:a.is_building_entrance=!1;for(var t=u.myPois,o=t.length,i=0;i<o;i++)if(t[i].puid==r){t.splice(i,1),u.myPoisHashT[r]&&u.myPoisHashT[r].marker&&u.myPoisHashT[r].marker.setMap(null),delete u.myPoisHashT[r],u.anyService.setAllPois(u.myPoisHashT);break}_suc(u,"Successfully deleted POI.")},function(e){e.data;for(var t=u.myPois,o=t.length,i=0;i<o;i++)if(t[i].puid==r){t.splice(i,1),u.myPoisHashT[r]&&u.myPoisHashT[r].marker&&u.myPoisHashT[r].marker.setMap(null),delete u.myPoisHashT[r],u.anyService.setAllPois(u.myPoisHashT);break}_err(u,"Something went wrong while deleting POI.")})},u.updatePoi=function(e){var t=u.myPoisHashT[e];if(!t||!t.model||!t.model.puid){if(!(u.myPoisHashT&&u.myMarkers&&u.myMarkers[e]&&u.myMarkers[e].model&&u.myPoisHashT[u.myMarkers[e].model.puid]))return void _err(u,"No valid POI selected to be updated.");if(!(t=u.myPoisHashT[u.myMarkers[e].model.puid])||!t.model||!t.model.puid)return void _err(u,"No valid POI selected to be updated.")}0!=t.model.pois_type2.localeCompare("")&&(t.model.pois_type=t.model.pois_type2);var a=t.model,r=t.marker;if(r){var o=r.position;o&&o.lat()&&o.lng()&&(a.coordinates_lat=String(o.lat()),a.coordinates_lon=String(o.lng()))}a.is_building_entrance?a.is_building_entrance="true":a.is_building_entrance="false",u.anyAPI.updatePois(a).then(function(e){e.data;for(var t in r&&r.infowindow.setMap(null),"true"==a.is_building_entrance?a.is_building_entrance=!0:a.is_building_entrance=!1,u.myConnectionsHashT)if(u.myConnectionsHashT.hasOwnProperty(t)&&(u.myConnectionsHashT[t].pois_a==a.puid||u.myConnectionsHashT[t].pois_b==a.puid)){var o=u.myConnectionsHashT[t].pois_a,i=u.myConnectionsHashT[t].pois_b,n=[new google.maps.LatLng(u.myPoisHashT[o].model.coordinates_lat,u.myPoisHashT[o].model.coordinates_lon),new google.maps.LatLng(u.myPoisHashT[i].model.coordinates_lat,u.myPoisHashT[i].model.coordinates_lon)];u.myConnectionsHashT[t].polyLine.setPath(n),u.anyService.setAllConnection(u.myConnectionsHashT),u.anyService.setAllPois(u.myPoisHashT)}},function(e){ShowError(u,e,"Something went wrong while updating POI. Please refresh and try again.",!0)})},u.updatePoiPosition=function(a){var r;a&&a.model&&(r=a.model);var e=a.position;e&&e.lat()&&e.lng()&&(r.coordinates_lat=String(e.lat()),r.coordinates_lon=String(e.lng())),r.is_building_entrance?r.is_building_entrance="true":r.is_building_entrance="false",u.anyAPI.updatePois(r).then(function(e){e.data;for(var t in"true"==r.is_building_entrance||!0===r.is_building_entrance?r.is_building_entrance=!0:r.is_building_entrance=!1,u.myConnectionsHashT)if(u.myConnectionsHashT.hasOwnProperty(t)&&(u.myConnectionsHashT[t].pois_a==a.model.puid||u.myConnectionsHashT[t].pois_b==a.model.puid)){var o=u.myConnectionsHashT[t].pois_a,i=u.myConnectionsHashT[t].pois_b,n=[new google.maps.LatLng(u.myPoisHashT[o].model.coordinates_lat,u.myPoisHashT[o].model.coordinates_lon),new google.maps.LatLng(u.myPoisHashT[i].model.coordinates_lat,u.myPoisHashT[i].model.coordinates_lon)];u.myConnectionsHashT[t].polyLine.setPath(n),u.anyService.setAllConnection(u.myConnectionsHashT),u.anyService.setAllPois(u.myPoisHashT)}},function(e){ShowError(u,e,"Something went wrong while moving POI.",!0)})},u.removeMarker=function(e){u.myMarkers[e]?(u.myMarkers[e].marker.setMap(null),delete u.myMarkers[e]):_err(u,"It seems that the marker to be deleted does not exist.")},u.placeMarker=function(e,t,o,i){var n=new google.maps.Marker({position:e,map:m.gmap,icon:new google.maps.MarkerImage(t,null,null,null,o),draggable:!0});if(null!==f.getBuildingId()&&void 0!==f.getBuildingId()){var a=new google.maps.InfoWindow({content:"-",maxWidth:500});u.$apply(function(){n.myId=u.myMarkerId,u.myMarkers[n.myId]={},u.myMarkers[n.myId].model={buid:f.getBuildingId(),floor_number:f.getFloorNumber(),floor_name:f.getFloorName(),is_door:"false",is_building_entrance:"false",is_published:"true",description:"connector"===i?"Connector":"",name:"connector"===i?"Connector":"",pois_type:"connector"===i?"None":"",pois_type2:"connector"===i?"None":"",url:"-",image:"url_to_pois_image"},u.myMarkers[n.myId].marker=n,u.myMarkers[n.myId].model.pois_type2=u.myMarkers[n.myId].model.pois_type,u.myMarkerId++});var r='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm"><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+n.myId+'].model.description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><select ng-model="myMarkers['+n.myId+'].model.pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">Select POI Type</option></select></fieldset class="form-group"><div><fieldset class="form-group"><div>Custom type:</div><input ng-model="myMarkers['+n.myId+'].model.pois_type2" id="poi-pois_type2" type="text" class="form-control" placeholder="POI Type" tabindex="2"></fieldset><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset></div><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addPoi('+n.myId+')" tabindex="3"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempPoi('+n.myId+')" tabindex="6"><i class="fa fa-trash text-white"></i></button></fieldset></div></form></div>',l='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm"><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+n.myId+'].model.description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><select ng-model="myMarkers['+n.myId+'].model.pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">Select POI Type</option></select></fieldset class="form-group"><div><fieldset class="form-group"><div>Custom type:</div><input ng-model="myMarkers['+n.myId+'].model.pois_type" id="poi-pois_type2" type="text" class="form-control" placeholder="POI Type" tabindex="2"></fieldset><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset></div><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="updatePoi('+n.myId+')" tabindex="3"><span class="glyphicon glyphicon-pencil"></span> Update</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi('+n.myId+')" tabindex="6"><i class="fa fa-trash text-white"></i></button></fieldset></div></form></div>',s='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><div style="margin-bottom: 5px">POI Connector</div><fieldset class="form-group" style="display: inline-block; width: 73%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addPoi('+n.myId+')"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempPoi('+n.myId+')"><i class="fa fa-trash text-white"></i></button></fieldset></div>',d='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><div style="margin-bottom: 5px">POI Connector</div><fieldset class="form-group"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi('+n.myId+')"><i class="fa fa-trash text-white"></i> Remove</button></fieldset></div>';if("poi"==i){r='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm"><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+n.myId+'].model.description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><select ng-model="myMarkers['+n.myId+'].model.pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">Select POI Type</option></select></fieldset class="form-group"><fieldset class="form-group">Or ender your one type name:<input ng-model="myMarkers['+n.myId+'].model.pois_type2" id="poi-pois_type2" type="text" class="form-control" placeholder="POI Type" tabindex="2"></fieldset><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addPoi('+n.myId+')" tabindex="3"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempPoi('+n.myId+')" tabindex="6"><i class="fa fa-trash text-white"></i></button></fieldset></div></form></div>',l='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm"><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+n.myId+'].model.description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><select ng-model="myMarkers['+n.myId+'].model.pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">Select POI Type</option></select></fieldset class="form-group"><fieldset class="form-group">Or ender your one type name:<input ng-model="myMarkers['+n.myId+'].model.pois_type" id="poi-pois_type2" type="text" class="form-control" placeholder="POI Type" tabindex="2"></fieldset><fieldset class="form-group"><input ng-model="myMarkers['+n.myId+'].model.is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="updatePoi('+n.myId+')" tabindex="3"><span class="glyphicon glyphicon-pencil"></span> Update</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi('+n.myId+')" tabindex="6"><i class="fa fa-trash text-white"></i></button></fieldset></div></form></div>';var c=g(r)(u);n.tpl2=g(l)(u),a.setContent(c[0]),a.open(m.gmap,n)}else if("connector"==i){s='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><div style="margin-bottom: 5px">POI Connector</div><fieldset class="form-group" style="display: inline-block; width: 73%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addPoi('+n.myId+')"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempPoi('+n.myId+')"><i class="fa fa-trash text-white"></i></button></fieldset></div>',d='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><div style="margin-bottom: 5px">POI Connector</div><fieldset class="form-group"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi('+n.myId+')"><i class="fa fa-trash text-white"></i> Remove</button></fieldset></div>';var p=g(s)(u);n.tpl2=g(d)(u),a.setContent(p[0]),u.addPoi(n.myId)}u.$apply(u.myMarkers[n.myId].infowindow=a),google.maps.event.addListener(n,"click",function(){u.edgeMode&&u.$apply(_warn(u,"Only submitted objects can be connected together.")),a.open(m.gmap,n)})}else _err(u,"It seems there is no building selected. Please refresh.")},u.deleteTempPoi=function(e){u.myMarkers&&u.myMarkers[e].marker?u.myMarkers[e].marker.setMap(null):_err(u,"No valid POI marker to delete found.")},u.toggleEdgeMode=function(){u.edgeMode=!u.edgeMode,u.edgeMode?document.getElementById("poi-edge-mode").classList.add("draggable-border-selected"):(u.connectPois.prev=void 0,document.getElementById("poi-edge-mode").classList.remove("draggable-border-selected"))},$("#draggable-poi").draggable({helper:"clone",stop:function(e){var t=new google.maps.Point(e.pageX,e.pageY),o=n.getProjection().fromContainerPixelToLatLng(t);i(o)?u.placeMarker(o,"build/images/poi-new.png",new google.maps.Size(32,32),"poi"):u.$apply(_warn(u,"The marker was placed too far away from the selected building."))}}),$("#draggable-connector").draggable({helper:"clone",stop:function(e){var t=new google.maps.Point(e.pageX,e.pageY),o=n.getProjection().fromContainerPixelToLatLng(t);i(o)?u.placeMarker(o,d,new google.maps.Size(21,21),"connector"):u.$apply(_warn(u,"The marker was placed too far away from the selected building."))}})}]),app.controller("SelectFloorController",["$scope","AnyplaceService","GMapService","AnyplaceAPIService",function(o,e,t,i){o.anyService=e,o.anyAPI=i,o.gmapService=t,o.xFloors=[],o.$watch("anyService.availableFloors",function(e,t){e&&(o.xFloors=[],o.xFloors=o.anyService.availableFloors)}),o.orderByFloorNo=function(e){return!e||LPUtils.isNullOrUndefined(e.floor_number)?0:parseInt(e.floor_number)},o.floorUp=function(){var e;changedfloor=!0;for(var t=0;t<o.xFloors.length;t++)if(e=t+1,o.xFloors[t].floor_number===o.anyService.selectedFloor.floor_number)return e<o.xFloors.length?void(o.anyService.selectedFloor=o.xFloors[e]):void 0;_err(o,"Floor not found.")},o.floorDown=function(){var e;changedfloor=!0;for(var t=0;t<o.xFloors.length;t++)if(e=t-1,o.xFloors[t].floor_number===o.anyService.selectedFloor.floor_number)return 0<=e?void(o.anyService.selectedFloor=o.xFloors[e]):void 0;_err(o,"Floor not found.")}}]);var heatmap,heatmapAcc,drawingManager,heatMap=[],heatMapAcces=[],APmap=[],heatmapFingerprints=[],userTimeData=[],fingerPrintsMap=[],connectionsMap={},POIsMap={},_HEATMAP_FINGERPRINT_COVERAGE=!1,_HEATMAP_ACCES=!1,_APs_IS_ON=!1,_FINGERPRINTS_IS_ON=!1,_DELETE_FINGERPRINTS_IS_ON=!1,_HEATMAP_F_IS_ON=!1,_CONNECTIONS_IS_ON=!1,_POIS_IS_ON=!1,colorBarGreenClicked=(changedfloor=!1,!1),colorBarYellowClicked=!1,colorBarOrangeClicked=!1,colorBarPurpleClicked=!1,colorBarRedClicked=!1,levelOfZoom=1;function clearLocalization(){console.log("clearLocalization");if(void 0!==heatMap_[0]&&null!==heatMap[0]){for(var e=heatMap.length;e--;)heatMap[e].rectangle.setMap(null),heatMap[e]=null;heatMap=[],document.getElementById("radioHeatmapRSS-mode").classList.remove("quickaction-selected"),_HEATMAP_ACCES=!1,setColorClicked("g",!1),setColorClicked("y",!1),setColorClicked("o",!1),setColorClicked("p",!1),setColorClicked("r",!1),$scope.radioHeatmapLocalization=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapLocalization","NO"),$scope.anyService.radioHeatmapLocalization=!1,$scope.radioHeatmapRSSHasGreen=!1,$scope.radioHeatmapRSSHasYellow=!1,$scope.radioHeatmapRSSHasOrange=!1,$scope.radioHeatmapRSSHasPurple=!1,$scope.radioHeatmapRSSHasRed=!1,$cookieStore.put("RSSClicked","NO")}}app.controller("WiFiController",["$cookieStore","$scope","AnyplaceService","GMapService","AnyplaceAPIService",function(g,y,e,p,t){y.anyService=e,y.anyAPI=t,y.gmapService=p,y.example9model=[],y.example9data=[],y.example9settings={enableSearch:!0,scrollable:!0},y.example8model=[],y.example8data=[],y.deleteButtonWarning=!1,y.radioHeatmapRSSMode=!1,y.radioHeatmapLocalization=!1,y.radioHeatmapRSSTimeMode=!1,y.fingerPrintsMode=!1,y.fingerPrintsTimeMode=!1,y.APsMode=!1,y.filterByMAC=!1,y.filterByMAN=!1,y.radioHeatmapRSSHasGreen=!1,y.radioHeatmapRSSHasYellow=!1,y.radioHeatmapRSSHasOrange=!1,y.radioHeatmapRSSHasPurple=!1,y.radioHeatmapRSSHasRed=!1,y.localizationAccMode=!1,y.selected="Filters:",y.initializeTime=!1,y.initializeFingerPrints=!1,y.initializeRadioHeatmapRSS=!1,y.initializeAPs=!1,y.initializeConnections=!1,y.initializePOIs=!1,y.initializeAcces=!1;var l,o;function P(){if(void 0!==heatMap[0]&&null!==heatMap[0]){for(var e=heatMap.length;e--;)heatMap[e].rectangle.setMap(null),heatMap[e]=null;heatMap=[],document.getElementById("radioHeatmapRSS-mode").classList.remove("quickaction-selected"),n("g",_HEATMAP_FINGERPRINT_COVERAGE=!1),n("y",!1),n("o",!1),n("p",!1),n("r",!1),y.radioHeatmapRSSMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","NO"),y.anyService.radioHeatmapRSSMode=!1,y.radioHeatmapRSSHasGreen=!1,y.radioHeatmapRSSHasYellow=!1,y.radioHeatmapRSSHasOrange=!1,y.radioHeatmapRSSHasPurple=!1,y.radioHeatmapRSSHasRed=!1,g.put("RSSClicked","NO")}}function S(){if(void 0!==fingerPrintsMap[0]&&null!==fingerPrintsMap[0]){for(var e=fingerPrintsMap.length;e--;)fingerPrintsMap[e].setMap(null),fingerPrintsMap[e]=null;_FINGERPRINTS_IS_ON=!(fingerPrintsMap=[]),document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected")}if(heatmap&&heatmap.getMap()){heatmap.setMap(null),_FINGERPRINTS_IS_ON=!1,document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),_HEATMAP_F_IS_ON=!1;for(e=heatmapFingerprints.length;e--;)heatmapFingerprints[e]=null;heatmapFingerprints=[]}}function v(){y.fingerPrintsMode&&(y.fingerPrintsTimeMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"),y.anyService.fingerPrintsTimeMode=!0,y.fingerPrintsMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","YES")),y.radioHeatmapRSSMode&&(y.radioHeatmapRSSTimeMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"),y.radioHeatmapRSSMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","YES"),y.anyService.radioHeatmapRSSTimeMode=!0,y.anyService.radioHeatmapRSSMode=!0),y.radioHeatmapLocalization&&(y.radioHeatmapRSSTimeMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"),y.radioHeatmapLocalization=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapLocalization","YES"),y.anyService.radioHeatmapRSSTimeMode=!0,y.anyService.radioHeatmapLocalization=!0),document.getElementById("fingerPrints-time-mode").classList.add("quickaction-selected")}function n(e,t){"g"===e?(colorBarGreenClicked=t)?document.getElementById("greenSquares").classList.add("faded"):document.getElementById("greenSquares").classList.remove("faded"):"y"===e?(colorBarYellowClicked=t)?document.getElementById("yellowSquares").classList.add("faded"):document.getElementById("yellowSquares").classList.remove("faded"):"o"===e?(colorBarOrangeClicked=t)?document.getElementById("orangeSquares").classList.add("faded"):document.getElementById("orangeSquares").classList.remove("faded"):"p"===e?(colorBarPurpleClicked=t)?document.getElementById("purpleSquares").classList.add("faded"):document.getElementById("purpleSquares").classList.remove("faded"):(colorBarRedClicked=t)?document.getElementById("redSquares").classList.add("faded"):document.getElementById("redSquares").classList.remove("faded")}function m(e){return"g"===e?colorBarGreenClicked:"y"===e?colorBarYellowClicked:"o"===e?colorBarOrangeClicked:"p"===e?colorBarPurpleClicked:colorBarRedClicked}y.crudTabSelected=1,y.setCrudTabSelected=function(e){y.crudTabSelected=e},y.isCrudTabSelected=function(e){return y.crudTabSelected===e},y.data={floor_plan_coords:{},floor_plan_base64_data:{},floor_plan_groundOverlay:null},y.$watch("anyService.selectedBuilding",function(e,t){if(e){if(void 0!==localStorage.getItem("fingerprintsMode")&&"YES"===localStorage.getItem("fingerprintsMode")&&(y.initializeFingerPrints=!0),void 0!==localStorage.getItem("radioHeatmapRSSMode")&&"YES"===localStorage.getItem("radioHeatmapRSSMode")&&(y.initializeRadioHeatmapRSS=!0),void 0!==localStorage.getItem("radioHeatmapLocalization")&&"YES"===localStorage.getItem("radioHeatmapLocalization")&&(y.initializeRadioHeatmapRSS=!0),void 0!==localStorage.getItem("APsMode")&&"YES"===localStorage.getItem("APsMode")&&(y.initializeAPs=!0),void 0!==localStorage.getItem("localizationAccMode")&&"YES"===localStorage.getItem("localizationAccMode")&&(y.initializeAcces=!0),void 0!==localStorage.getItem("connectionsMode")&&"NO"===localStorage.getItem("connectionsMode")&&(y.initializeConnections=!0),void 0!==localStorage.getItem("POIsMode")&&"NO"===localStorage.getItem("POIsMode")&&(y.initializePOIs=!0),void 0!==localStorage.getItem("fingerPrintsTimeMode")&&"YES"===localStorage.getItem("fingerPrintsTimeMode")&&(y.initializeTime=!0),window.onload=function(){y.initializeFingerPrints&&($("#heatmapTab").click(),$("#FPs").click(),$("#FPsButton").click()),y.initializeRadioHeatmapRSS&&($("#heatmapTab").click(),$("#HMs").click(),$("#HMsButton").click()),y.initializeAPs&&($("#heatmapTab").click(),$("#HMs").click(),$("#APsButton").click()),y.initializeAcces&&($("#heatmapTab").click(),$("#LAs").click(),$("#LAButton").click()),y.initializeConnections&&($("#FPs").click(),$("#connectionsButton").click()),y.initializePOIs&&($("#FPs").click(),$("#POIsButton").click()),y.initializeTime&&($("#heatmapTab").click(),$("#FPs").click(),$("#FPsTimeButton").click())},_HEATMAP_FINGERPRINT_COVERAGE){for(var o=heatMap.length;o--;)heatMap[o].rectangle.setMap(null),heatMap[o]=null;heatMap=[],y.showFingerprintCoverage(),y.radioHeatmapRSSTimeMode&&(d3.selectAll("svg > *").remove(),$("svg").remove(),y.getFingerPrintsTime())}if(_APs_IS_ON){for(o=APmap.length;o--;)APmap[o].setMap(null),APmap[o]=null,y.example9data[o]=null,y.example9model[o]=null;for(o=y.example8data.length;o--;)y.example8data[o]=null,y.example8model[o]=null;APmap=[],y.example9data=[],y.example9model=[],y.example8data=[],y.example8model=[],y.showAPs()}if(_HEATMAP_ACCES){for(o=heatMapAcces.length;o--;)heatMapAcces[o].setMap(null),heatMapAcces[o]=null;heatMapAcces=[],y.showLocalizationAccHeatmap()}if(_FINGERPRINTS_IS_ON){for(o=fingerPrintsMap.length;o--;)fingerPrintsMap[o].setMap(null),fingerPrintsMap[o]=null;fingerPrintsMap=[],y.showFingerprintHeatmap(),y.fingerPrintsTimeMode&&!y.radioHeatmapRSSTimeMode&&(d3.selectAll("svg > *").remove(),$("svg").remove(),y.getFingerPrintsTime())}if(heatmap&&heatmap.getMap()){heatmap.setMap(null);for(o=heatmapFingerprints.length;o--;)heatmapFingerprints[o]=null;_HEATMAP_F_IS_ON=!(heatmapFingerprints=[]),y.showFingerprintHeatmap(),y.fingerPrintsTimeMode&&!y.radioHeatmapRSSTimeMode&&(d3.selectAll("svg > *").remove(),$("svg").remove(),y.getFingerPrintsTime())}heatmapAcc&&heatmapAcc.getMap()&&(heatmapAcc.setMap(null),y.showLocalizationAccHeatmap())}if(!_CONNECTIONS_IS_ON){connectionsMap=y.anyService.getAllConnections();var i=Object.keys(connectionsMap);if(void 0!==connectionsMap[i[0]]&&void 0!==connectionsMap[i[0]].polyLine&&null!==connectionsMap[i[0]].polyLine.getMap()){for(var i in connectionsMap)if(connectionsMap.hasOwnProperty(i)){var n=connectionsMap[i];n&&n.polyLine&&n.polyLine.setMap(null)}y.anyService.setAllConnection(connectionsMap),connectionsMap={}}if(!_POIS_IS_ON&&void 0!==(POIsMap=y.anyService.getAllPois())){i=Object.keys(POIsMap);if(void 0!==POIsMap[i[0]]&&null!==POIsMap[i[0]].marker.getMap()){for(var i in POIsMap)if(POIsMap.hasOwnProperty(i)){var a=POIsMap[i];a&&a.marker&&a.marker.setMap(null)}y.anyService.setAllPois(POIsMap),POIsMap={}}}changedfloor=!1}}),y.$watch("newFloorNumber",function(e,t){}),y.$watch("anyService.selectedFloor",function(e,t){if(null!=e&&!_.isEqual(e,t)){if("undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastFloor",e.floor_number),_HEATMAP_FINGERPRINT_COVERAGE){for(var o=heatMap.length;o--;)heatMap[o].rectangle.setMap(null),heatMap[o]=null;heatMap=[],y.showFingerprintCoverage(),y.radioHeatmapRSSTimeMode&&(d3.selectAll("svg > *").remove(),$("svg").remove(),y.getFingerPrintsTime())}if(_APs_IS_ON){for(o=APmap.length;o--;)APmap[o].setMap(null),APmap[o]=null,y.example9data[o]=null,y.example9model[o]=null;for(o=y.example8data.length;o--;)y.example8data[o]=null,y.example8model[o]=null;APmap=[],y.example9data=[],y.example9model=[],y.example8data=[],y.example8model=[],y.showAPs()}if(_FINGERPRINTS_IS_ON){for(o=fingerPrintsMap.length;o--;)fingerPrintsMap[o].setMap(null),fingerPrintsMap[o]=null;fingerPrintsMap=[],y.showFingerprintHeatmap(),y.fingerPrintsTimeMode&&!y.radioHeatmapRSSTimeMode&&(d3.selectAll("svg > *").remove(),$("svg").remove(),y.getFingerPrintsTime())}if(heatmap&&heatmap.getMap()){heatmap.setMap(null);for(o=heatmapFingerprints.length;o--;)heatmapFingerprints[o]=null;_HEATMAP_F_IS_ON=!(heatmapFingerprints=[]),y.showFingerprintHeatmap(),y.fingerPrintsTimeMode&&!y.radioHeatmapRSSTimeMode&&(d3.selectAll("svg > *").remove(),$("svg").remove(),y.getFingerPrintsTime())}heatmapAcc&&heatmapAcc.getMap()&&(heatmapAcc.setMap(null),y.showLocalizationAccHeatmap());if(!_CONNECTIONS_IS_ON){connectionsMap=y.anyService.getAllConnections();var i=Object.keys(connectionsMap);if(void 0!==connectionsMap[i[0]]&&void 0!==connectionsMap[i[0]].polyLine&&null!==connectionsMap[i[0]].polyLine.getMap()){for(var i in connectionsMap)if(connectionsMap.hasOwnProperty(i)){var n=connectionsMap[i];n&&n.polyLine&&n.polyLine.setMap(null)}y.anyService.setAllConnection(connectionsMap),connectionsMap={}}}if(!_POIS_IS_ON&&void 0!==(POIsMap=y.anyService.getAllPois())){i=Object.keys(POIsMap);if(void 0!==POIsMap[i[0]]&&null!==POIsMap[i[0]].marker.getMap()){for(var i in POIsMap)if(POIsMap.hasOwnProperty(i)){var a=POIsMap[i];a&&a.marker&&a.marker.setMap(null)}y.anyService.setAllPois(POIsMap),POIsMap={}}}changedfloor=!1}}),y.toggleCoverage=function(){LOG.D2("toggleCoverage"),_HEATMAP_FINGERPRINT_COVERAGE&&y.fingerPrintsTimeMode&&(y.fingerPrintsTimeMode=!y.fingerPrintsTimeMode,y.fingerPrintsTimeMode?"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"):"undefined"!=typeof Storage&&localStorage&&!y.radioHeatmapRSSTimeMode&&localStorage.setItem("fingerPrintsTimeMode","NO"),y.anyService.fingerPrintsTimeMode=!y.anyService.fingerPrintsTimeMode);if(void 0!==heatMap[0]&&null!==heatMap[0]||y.radioHeatmapRSSTimeMode){for(var e=heatMap.length;e--;)heatMap[e].rectangle.setMap(null),heatMap[e]=null;return heatMap=[],document.getElementById("radioHeatmapRSS-mode").classList.remove("quickaction-selected"),n("g",_HEATMAP_FINGERPRINT_COVERAGE=!1),n("y",!1),n("o",!1),n("p",!1),n("r",!1),y.radioHeatmapRSSMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","NO"),y.anyService.radioHeatmapRSSMode=!1,y.radioHeatmapRSSTimeMode=!1,"undefined"!=typeof Storage&&localStorage&&!y.fingerPrintsTimeMode&&localStorage.setItem("fingerPrintsTimeMode","NO"),y.anyService.radioHeatmapRSSTimeMode=!1,y.radioHeatmapRSSHasGreen=!1,y.radioHeatmapRSSHasYellow=!1,y.radioHeatmapRSSHasOrange=!1,y.radioHeatmapRSSHasPurple=!1,y.radioHeatmapRSSHasRed=!1,y.fingerPrintsMode||document.getElementById("fingerPrints-time-mode").classList.remove("quickaction-selected"),void g.put("RSSClicked","NO")}y.fingerPrintsTimeMode&&(y.radioHeatmapRSSTimeMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"),y.anyService.radioHeatmapRSSTimeMode=!0),document.getElementById("radioHeatmapRSS-mode").classList.add("quickaction-selected"),y.radioHeatmapRSSMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","YES"),y.anyService.radioHeatmapRSSMode=!0,y.showFingerprintCoverage()},y.toggleAPs=function(){if(void 0!==APmap[0]&&null!==APmap[0]){for(var e=APmap.length;e--;)APmap[e].setMap(null),APmap[e]=null,y.example9data[e]=null,y.example9model[e]=null;for(e=y.example8data.length;e--;)y.example8data[e]=null,y.example8model[e]=null;return APmap=[],y.example9data=[],y.example9model=[],y.example8data=[],y.example8model=[],_APs_IS_ON=!1,y.filterByMAC=!1,y.filterByMAN=!1,document.getElementById("APs-mode").classList.remove("quickaction-selected"),y.APsMode=!1,void("undefined"!=typeof Storage&&localStorage&&localStorage.setItem("APsMode","NO"))}_APs_IS_ON=!0,y.APsMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("APsMode","YES"),document.getElementById("APs-mode").classList.add("quickaction-selected"),y.showAPs()},y.toggleFingerPrints=function(){if(LOG.D2("toggleFingerPrints"),_HEATMAP_FINGERPRINT_COVERAGE&&y.fingerPrintsTimeMode)return y.toggleCoverage(),void y.toggleFingerPrints();y.fingerPrintsMode=!y.fingerPrintsMode,y.fingerPrintsMode?(document.getElementById("fingerPrints-mode").classList.add("quickaction-selected"),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","YES")):(document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","NO"));if(void 0!==fingerPrintsMap[0]&&null!==fingerPrintsMap[0]){for(var e=fingerPrintsMap.length;e--;)fingerPrintsMap[e].setMap(null),fingerPrintsMap[e]=null;return _FINGERPRINTS_IS_ON=!(fingerPrintsMap=[]),document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),y.fingerPrintsMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","NO"),y.fingerPrintsTimeMode=!1,"undefined"!=typeof Storage&&localStorage&&!y.radioHeatmapRSSTimeMode&&localStorage.setItem("fingerPrintsTimeMode","NO"),y.anyService.fingerPrintsTimeMode=!1,void(y.radioHeatmapRSSMode||document.getElementById("fingerPrints-time-mode").classList.remove("quickaction-selected"))}if(heatmap&&heatmap.getMap()){heatmap.setMap(null),_FINGERPRINTS_IS_ON=!1,document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),y.fingerPrintsMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","NO"),y.fingerPrintsTimeMode=!1,"undefined"!=typeof Storage&&localStorage&&!y.radioHeatmapRSSTimeMode&&localStorage.setItem("fingerPrintsTimeMode","NO"),y.anyService.fingerPrintsTimeMode=!1,_HEATMAP_F_IS_ON=!1,y.radioHeatmapRSSMode||document.getElementById("fingerPrints-time-mode").classList.remove("quickaction-selected");for(e=heatmapFingerprints.length;e--;)heatmapFingerprints[e]=null;heatmapFingerprints=[]}else document.getElementById("fingerPrints-mode").classList.add("quickaction-selected"),y.fingerPrintsMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","YES"),y.radioHeatmapRSSTimeMode&&(y.fingerPrintsTimeMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"),y.anyService.fingerPrintsTimeMode=!0),y.showFingerprintHeatmap()},y.toggleLocalizationAccuracy=function(){if(void 0!==heatMapAcces[0]&&null!==heatMapAcces[0]||y.radioHeatmapLocalization){for(var e=heatMapAcces.length;e--;)heatMapAcces[e].setMap(null),heatMapAcces[e]=null;return n("g",_HEATMAP_ACCES=!(heatMapAcces=[])),n("y",!1),n("o",!1),n("p",!1),n("r",!1),document.getElementById("localizationAccuracy-mode").classList.remove("quickaction-selected"),y.radioHeatmapLocalization=!1,y.localizationAccMode=!1,void("undefined"!=typeof Storage&&localStorage&&localStorage.setItem("localizationAccMode","NO"))}y.showLocalizationAccHeatmap(),document.getElementById("localizationAccuracy-mode").classList.add("quickaction-selected")},y.toggleFingerPrintsTime=function(){LOG.D2("toggleFingerPrintsTime"),y.fingerPrintsMode&&(y.fingerPrintsTimeMode=!y.fingerPrintsTimeMode,y.fingerPrintsTimeMode?"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"):"undefined"!=typeof Storage&&localStorage&&!y.radioHeatmapRSSTimeMode&&localStorage.setItem("fingerPrintsTimeMode","NO"),y.anyService.fingerPrintsTimeMode=!y.anyService.fingerPrintsTimeMode),y.radioHeatmapRSSMode&&(y.radioHeatmapRSSTimeMode=!y.radioHeatmapRSSTimeMode,y.radioHeatmapRSSTimeMode?"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerPrintsTimeMode","YES"):"undefined"!=typeof Storage&&localStorage&&!y.fingerPrintsTimeMode&&localStorage.setItem("fingerPrintsTimeMode","NO"),y.anyService.radioHeatmapRSSTimeMode=!y.anyService.radioHeatmapRSSTimeMode),y.radioHeatmapLocalization&&(clearLocalization(),y.showFingerprintCoverage(),y.radioHeatmapRSSMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","YES"),y.anyService.radioHeatmapRSSMode=!0,document.getElementById("radioHeatmapRSS-mode").classList.add("quickaction-selected"),document.getElementById("fingerPrints-time-mode").classList.remove("quickaction-selected")),!y.fingerPrintsTimeMode&&y.fingerPrintsMode&&(S(),y.showFingerprintHeatmap(),document.getElementById("fingerPrints-mode").classList.add("quickaction-selected"),document.getElementById("fingerPrints-time-mode").classList.remove("quickaction-selected")),!y.radioHeatmapRSSTimeMode&&y.radioHeatmapRSSMode&&(P(),y.showFingerprintCoverage(),y.radioHeatmapRSSMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","YES"),y.anyService.radioHeatmapRSSMode=!0,document.getElementById("radioHeatmapRSS-mode").classList.add("quickaction-selected"),document.getElementById("fingerPrints-time-mode").classList.remove("quickaction-selected")),(y.radioHeatmapRSSTimeMode||y.fingerPrintsTimeMode)&&y.getFingerPrintsTime()},y.togglePOIs=function(){POIsMap=y.anyService.getAllPois();var e=Object.keys(POIsMap);if(POIsMap.hasOwnProperty(e[0])){if(null!==POIsMap[e[0]].marker.getMap()&&void 0!==POIsMap[e[0]].marker.getMap()){for(var e in POIsMap){if(POIsMap.hasOwnProperty(e))(t=POIsMap[e])&&t.marker&&t.marker.setMap(null)}return y.anyService.setAllPois(POIsMap),_POIS_IS_ON=!(POIsMap={}),void("undefined"!=typeof Storage&&localStorage&&localStorage.setItem("POIsMode","NO"))}for(var e in POIsMap){var t;if(POIsMap.hasOwnProperty(e))(t=POIsMap[e])&&t.marker&&t.marker.setMap(p.gmap)}y.anyService.setAllPois(POIsMap),_POIS_IS_ON=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("POIsMode","YES")}else _err(y,"No POIs yet.")},y.toggleConnections=function(){connectionsMap=y.anyService.getAllConnections();var e=Object.keys(connectionsMap);if(connectionsMap.hasOwnProperty(e[0])){if(void 0!==connectionsMap[e[0]].polyLine&&void 0!==connectionsMap[e[0]].polyLine.getMap()&&null!==connectionsMap[e[0]].polyLine.getMap()){for(var e in connectionsMap)if(connectionsMap.hasOwnProperty(e)){var t=connectionsMap[e];t&&t.polyLine&&t.polyLine.setMap(null)}return y.anyService.setAllConnection(connectionsMap),_CONNECTIONS_IS_ON=!(connectionsMap={}),void("undefined"!=typeof Storage&&localStorage&&localStorage.setItem("connectionsMode","NO"))}y.showConnections()}else _warn_autohide(y,"No edges yet.")},y.getHeatMapButtonText=function(){return void 0!==heatMap[0]&&null!==heatMap[0]?"Hide WiFi Map":"Show WiFi Map"},y.getAPsButtonText=function(){return void 0!==APmap[0]&&null!==APmap[0]?"Hide Estimated Wi-Fi AP Position":"Show Estimated Wi-Fi AP Position"},y.getFingerPrintsButtonText=function(){return void 0!==fingerPrintsMap[0]&&null!==fingerPrintsMap[0]||heatmap&&heatmap.getMap()?"Hide Fingerprints":"Show Fingerprints"},y.getFingerPrintTimeButtonText=function(){return y.fingerPrintsTimeMode?"Hide Fingerprints By Time":"Show Fingerprints By Time"},y.getHeatMapTimeButtonText=function(){return y.radioHeatmapRSSTimeMode?"Hide WiFi Map By Time":"Show WiFi Map By Time"},y.getLocalizationAccuracyText=function(){return y.localizationAccMode?"Hide ACCES Map":"Show ACCES Map"},y.getPOIsButtonText=function(){POIsMap=y.anyService.getAllPois();var e=Object.keys(POIsMap);return POIsMap.hasOwnProperty(e[0])&&void 0!==POIsMap[e[0]].marker.getMap()&&null!==POIsMap[e[0]].marker.getMap()?(document.getElementById("POIs-mode").classList.add("quickaction-selected"),y.POIsMode=!0,"Hide POIs"):(document.getElementById("POIs-mode").classList.remove("quickaction-selected"),y.POIsMode=!1,"Show POIs")},y.getConnectionsButtonText=function(){connectionsMap=y.anyService.getAllConnections();var e=Object.keys(connectionsMap);return connectionsMap.hasOwnProperty(e[0])&&void 0!==connectionsMap[e[0]].polyLine&&void 0!==connectionsMap[e[0]].polyLine.getMap()&&null!==connectionsMap[e[0]].polyLine.getMap()?(document.getElementById("connections-mode").classList.add("quickaction-selected"),y.connectionsMode=!0,"Hide Edges"):(document.getElementById("connections-mode").classList.remove("quickaction-selected"),y.connectionsMode=!1,"Show Edges")},$("#HMs_1").unbind().click(function(){$("#heatmapTab").click(),$("#HMs").click(),$("#HMsButton").click()}),$("#APs_1").unbind().click(function(){$("#heatmapTab").click(),$("#HMs").click(),$("#APsButton").click()}),$("#FPs_1").unbind().click(function(){$("#heatmapTab").click(),$("#FPs").click(),$("#FPsButton").click()}),$("#deleteFingerprintsSpn").unbind().click(function(){$("#heatmapTab").click(),$("#FPs").click(),$("#deleteButton").click()}),$("#FPs_2").unbind().click(function(){$("#heatmapTab").click(),$("#FPs").click(),$("#FPsTimeButton").click()}),$("#LA_1").unbind().click(function(){$("#heatmapTab").click(),$("#LAs").click(),$("#LAButton").click()}),$("#POIs_1").unbind().click(function(){$("#FPs").click(),$("#POIsButton").click()}),$("#CNs_1").unbind().click(function(){$("#FPs").click(),$("#connectionsButton").click()}),y.getHeatmapModeText=function(){return y.radioHeatmapRSSMode?"WiFi Map is online":"WiFi Map is offline"},y.getAPsModeText=function(){return y.APsMode?"Estimated Wi-Fi AP Position is online":"Estimated Wi-Fi AP Position is offline"},y.getFingerPrintsModeText=function(){return y.fingerPrintsMode?"FingerPrints are online":"FingerPrints are offline"},y.getDeleteFingerPrintsModeText=function(){return y.deleteFingerPrintsMode?"ON":"OFF"},y.getFingerPrintsTimeModeText=function(){return y.fingerPrintsTimeMode||y.radioHeatmapRSSTimeMode?"ON":"OFF"},y.getLocalizationAccuracyModeText=function(){return y.localizationAccMode?"Localization is online":"Localization is offline"},y.getPOIsModeText=function(){return y.POIsMode?"POIs are online":"POIs are offline"},y.getConnectionsModeText=function(){return y.connectionsMode?"Edges are online":"Edges are offline"},y.deleteFingerPrints=function(){if(console.log("deleteFingerPrints"),_DELETE_FINGERPRINTS_IS_ON)return drawingManager.setMap(null),y.deleteButtonWarning=!1,document.getElementById("delete-mode").classList.remove("quickaction-selected"),_DELETE_FINGERPRINTS_IS_ON=!1,void(y.deleteFingerPrintsMode=!1);var l,s,d,c;_FINGERPRINTS_IS_ON||heatmap&&heatmap.getMap()?(y.deleteButtonWarning=!0,y.deleteFingerPrintsMode=!0,_DELETE_FINGERPRINTS_IS_ON=!0,document.getElementById("delete-mode").classList.add("quickaction-selected"),(drawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.RECTANGLE,drawingControl:!1,rectangleOptions:{strokeColor:"#13B3E7",fillColor:"#ADD8E6",fillOpacity:.5}})).setMap(p.gmap),google.maps.event.addListener(drawingManager,"overlaycomplete",function(e){l=e.overlay.getBounds(),s=l.getNorthEast(),d=l.getSouthWest();for(var t=fingerPrintsMap.length;t--;)if(fingerPrintsMap[t].getPosition().lat()<=s.lat()&&fingerPrintsMap[t].getPosition().lng()<=s.lng()&&fingerPrintsMap[t].getPosition().lat()>=d.lat()&&fingerPrintsMap[t].getPosition().lng()>=d.lng()){c=confirm("Confirm:\nAre you sure you want to delete the selected fingerprints?");break}for(t=heatmapFingerprints.length;t--;)if(heatmapFingerprints[t].getPosition().lat()<=s.lat()&&heatmapFingerprints[t].getPosition().lng()<=s.lng()&&heatmapFingerprints[t].getPosition().lat()>=d.lat()&&heatmapFingerprints[t].getPosition().lng()>=d.lng()){c=confirm("Confirm:\nAre you sure you want to delete the selected fingerprints?");break}if(void 0===c)return alert("You have to select an area with Fingerprints to delete. "),e.overlay.setMap(null),drawingManager.setMap(null),y.deleteButtonWarning=!1,_DELETE_FINGERPRINTS_IS_ON=!1,y.deleteFingerPrintsMode=!1,void document.getElementById("delete-mode").classList.remove("quickaction-selected");if(c){var o,i=y.anyService.getBuilding(),n=y.anyService.getFloorNumber(),a={};if(!i||!i.buid)return void _err(y,"No building selected");a.buid=i.buid,a.floor=n,a.lat1=s.lat()+"",a.lon1=s.lng()+"",a.lat2=d.lat()+"",a.lon2=d.lng()+"",o=y.fingerPrintsTimeMode?(null==userTimeData[0]&&(userTimeData[0]=0),null==userTimeData[1]&&(userTimeData[1]=Number.MAX_SAFE_INTEGER),a.timestampX=userTimeData[0]+"",a.timestampY=userTimeData[1]+"",y.anyAPI.deleteFingerprintsByTime(a)):y.anyAPI.deleteFingerprints(a);var r=[];_HEATMAP_F_IS_ON||_HEATMAP_FINGERPRINT_COVERAGE?_HEATMAP_F_IS_ON&&!_HEATMAP_FINGERPRINT_COVERAGE?_suc(y,"The fingerprints are scheduled to be deleted. A new radiomap for fingerprints will be regenerated shortly after."):!_HEATMAP_F_IS_ON&&_HEATMAP_FINGERPRINT_COVERAGE?_suc(y,"The fingerprints are scheduled to be deleted. A new radiomap for Wi-Fi coverage will be regenerated shortly after."):_HEATMAP_F_IS_ON&&_HEATMAP_FINGERPRINT_COVERAGE&&_suc(y,"The fingerprints are scheduled to be deleted. New radiomaps for fingerprints and Wi-Fi coverage will be regenerated shortly after."):_suc(y,"The fingerprints are scheduled to be deleted."),o.then(function(e){if(0<(r=e.data.fingerprints).length){console.log("Deleted "+r.length+" fingerprints.");for(var t=fingerPrintsMap.length;t--;)fingerPrintsMap[t].getPosition().lat()<=s.lat()&&fingerPrintsMap[t].getPosition().lng()<=s.lng()&&fingerPrintsMap[t].getPosition().lat()>=d.lat()&&fingerPrintsMap[t].getPosition().lng()>=d.lng()&&fingerPrintsMap[t].setMap(null);if(_HEATMAP_F_IS_ON){heatmap.setMap(null);var o=[];for(t=heatmapFingerprints.length;t--;)null!==heatmapFingerprints[t]&&(heatmapFingerprints[t].getPosition().lat()>s.lat()||heatmapFingerprints[t].getPosition().lng()>s.lng()||heatmapFingerprints[t].getPosition().lat()<d.lat()||heatmapFingerprints[t].getPosition().lng()<d.lng()?o.push({location:heatmapFingerprints[t].getPosition(),weight:1}):heatmapFingerprints[t]=null);(heatmap=new google.maps.visualization.HeatmapLayer({data:o})).setMap(y.gmapService.gmap)}if(_HEATMAP_FINGERPRINT_COVERAGE)for(t=heatMap.length;t--;)heatMap[t].location.lat()<=s.lat()&&heatMap[t].location.lng()<=s.lng()&&heatMap[t].location.lat()>=d.lat()&&heatMap[t].location.lng()>=d.lng()&&heatMap[t].rectangle.setMap(null);if(_HEATMAP_ACCES)for(t=heatMapAcces.length;t--;)heatMapAcces[t].location.lat()<=s.lat()&&heatMapAcces[t].location.lng()<=s.lng()&&heatMapAcces[t].location.lat()>=d.lat()&&heatMapAcces[t].location.lng()>=d.lng()&&heatMapAcces[t].setMap(null);_suc(y,"Successfully deleted "+r.length+" fingerPrints.")}else _warn(y,"No fingerprints deleted.")},function(e){ShowError(y,e,"Something went wrong. It's likely that everything related to the fingerPrints is deleted but please refresh to make sure or try again.",!0),document.getElementById("delete-mode").classList.remove("quickaction-selected")})}e.overlay.setMap(null),drawingManager.setMap(null),y.deleteButtonWarning=!1,_DELETE_FINGERPRINTS_IS_ON=!1,y.deleteFingerPrintsMode=!1,document.getElementById("delete-mode").classList.remove("quickaction-selected")})):_warn_autohide(y,"Press 'Show Fingerprints' button first")},y.getColorBarTextFor=function(e){return m(e.charAt(0))?"click to show "+e+" ones":"click to hide "+e+" ones"},y.hideRSSExcept=function(e){if("g"!==e||y.radioHeatmapRSSHasGreen)if("y"!==e||y.radioHeatmapRSSHasYellow)if("o"!==e||y.radioHeatmapRSSHasOrange)if("p"!==e||y.radioHeatmapRSSHasPurple)if("r"!==e||y.radioHeatmapRSSHasRed){for(var t=heatMap.length;t--;)m(e)?heatMap[t].id===e&&(heatMap[t].rectangle.setMap(y.gmapService.gmap),heatMap[t].clicked=!0):heatMap[t].id===e&&(heatMap[t].rectangle.setMap(null),heatMap[t].clicked=!1);n(e,!m(e))}else _warn_autohide(y,"Coverage map has no red squares");else _warn_autohide(y,"Coverage map has no purple squares");else _warn_autohide(y,"Coverage map has no orange squares");else _warn_autohide(y,"Coverage map has no yellow squares");else _warn_autohide(y,"Coverage map has no green squares")},y.showFingerprintCoverage=function(){var e,t;P(),S(),y.fingerPrintsMode=!1,!_HEATMAP_FINGERPRINT_COVERAGE&&y.fingerPrintsTimeMode&&_MAX_ZOOM_LEVEL<=l&&(LOG.D2("REMOVE TILES"),y.fingerPrintsTimeMode=!1),l=p.gmap.getZoom(),void 0!==(t=(y.radioHeatmapRSSTimeMode||y.fingerPrintsTimeMode)&&0<userTimeData.length?(e={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber(),timestampX:userTimeData[0],timestampY:userTimeData[1]},MIN_ZOOM_FOR_HEATMAPS<l&&l<MAX_ZOOM_FOR_HEATMAPS?(levelOfZoom=2,y.anyAPI.getRadioHeatmapRSSByTime_2(e)):MIN_ZOOM_FOR_HEATMAPS<l?(levelOfZoom=3,y.anyAPI.getRadioHeatmapRSSByTime_3(e)):(levelOfZoom=1,y.anyAPI.getRadioHeatmapRSSByTime_1(e))):(e={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber()},MIN_ZOOM_FOR_HEATMAPS<l&&l<MAX_ZOOM_FOR_HEATMAPS?(levelOfZoom=2,y.anyAPI.getRadioHeatmapRSS_2(e)):MIN_ZOOM_FOR_HEATMAPS<l?(levelOfZoom=3,y.anyAPI.getRadioHeatmapRSS_3(e)):(levelOfZoom=1,y.anyAPI.getRadioHeatmapRSS_1(e))))&&t.then(function(e){e.data;var t=[],o=e.data.radioPoints.length;if(o<=0)return _err(y,"This floor seems not to be WiFi mapped. Download the Anyplace app from the Google Play store to map the floor."),void(y.radioHeatmapRSSTimeMode?_warn_autohide(y,"No fingerprints at this period."):(document.getElementById("radioHeatmapRSS-mode").classList.remove("quickaction-selected"),y.radioHeatmapRSSMode=!1,"undefined"!=typeof Storage&&localStorage&&!y.fingerPrintsTimeMode&&localStorage.setItem("radioHeatmapRSSMode","NO")));for(var i=0;o--;){var n=e.data.radioPoints[o],a=JSON.parse(n.w);(p=parseFloat(a.average))<=-30&&-60<=p?(t.push({location:new google.maps.LatLng(n.x,n.y),weight:p,color:"#4ed419",id:"g"}),y.radioHeatmapRSSHasGreen=!0):p<-60&&-70<=p?(t.push({location:new google.maps.LatLng(n.x,n.y),weight:p,color:"#ffff00",id:"y"}),y.radioHeatmapRSSHasYellow=!0):p<-70&&-90<=p?(t.push({location:new google.maps.LatLng(n.x,n.y),weight:p,color:"#ffa500",id:"o"}),y.radioHeatmapRSSHasOrange=!0):p<-90&&-100<=p?(t.push({location:new google.maps.LatLng(n.x,n.y),weight:p,color:"#bd06bd",id:"p"}),y.radioHeatmapRSSHasPurple=!0):(t.push({location:new google.maps.LatLng(n.x,n.y),weight:p,color:"#ff0000",id:"r"}),y.radioHeatmapRSSHasRed=!0);var r,l=t[i].location;r=3==levelOfZoom?new google.maps.Size(.75,.75):2==levelOfZoom?new google.maps.Size(2,2):new google.maps.Size(5,5);var s=google.maps.geometry.spherical.computeOffset(l,r.height,0).lat(),d=google.maps.geometry.spherical.computeOffset(l,r.height,180).lat(),c=google.maps.geometry.spherical.computeOffset(l,r.width,90).lng(),p=google.maps.geometry.spherical.computeOffset(l,r.width,270).lng(),u=new google.maps.Rectangle({strokeColor:t[i].color,strokeOpacity:1,strokeWeight:1,fillColor:t[i].color,fillOpacity:.5,bounds:new google.maps.LatLngBounds(new google.maps.LatLng(d,p),new google.maps.LatLng(s,c))});m(t[i].id)?u.setMap(null):u.setMap(y.gmapService.gmap),heatMap.push({rectangle:u,location:l,id:t[i].id,clicked:!1}),i++,e.data.radioPoints.splice(o,1)}_HEATMAP_FINGERPRINT_COVERAGE=!0,g.put("RSSClicked","YES")},function(e){ShowError(y,e,"Something went wrong while fetching radio heatmap.",!0),y.radioHeatmapRSSTimeMode||(y.radioHeatmapRSSMode=!1,"undefined"!=typeof Storage&&localStorage&&!y.fingerPrintsTimeMode&&localStorage.setItem("radioHeatmapRSSMode","NO"),document.getElementById("radioHeatmapRSS-mode").classList.remove("quickaction-selected"))})},y.getAPsIds=function(e){var t={};t.ids=e,y.anyAPI.getAPsIds(t).then(function(e){var t=e.data.accessPoints,o=t.length;if(o<=0)_err(y,"Access Points seems to not have ids");else{for(var i=new Set;o--;)APmap[o].mun=t[o],i.add(t[o]);i.forEach(function(e){"N/A"!==e&&(y.example8data.push({id:e,label:e}),y.example8model.push({id:e,label:e}))})}},function(e){ShowError(y,e,"Something went wrong while fetching the ids of access points.",!0)})},y.showAPs=function(){var c,e={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber()};e.username=y.creds.username,e.password=y.creds.password,y.anyAPI.getAPs(e).then(function(e){if((c=e.data.accessPoints.length)<=0)return _warn_autohide(y,"This floor seems not to be Access Point mapped. Download the Anyplace app from the Google Play store to map the floor."),y.APsMode=!1,void document.getElementById("APs-mode").classList.remove("quickaction-selected");var t=e.data.accessPoints;c=t.length;var o=IMG_ACCESS_POINT_ARCHITECT,i=new google.maps.Size(40,40);c=t.length;for(var n,a,r=0,l=[];c--;){if(1e3==r){_err(y,"Access Points have exceeded the maximun limit of 1000");break}a=0!=t[c].den?(n=t[c].x/t[c].den,t[c].y/t[c].den):(n=t[c].x,t[c].y),y.example9data.push({id:t[c].AP,label:t[c].AP}),y.example9model.push({id:t[c].AP,label:t[c].AP});var s=new google.maps.Marker({id:t[c].AP,position:new google.maps.LatLng(n,a),map:p.gmap,zIndex:9999,icon:new google.maps.MarkerImage(o,null,null,null,i)});APmap.push(s),l.push(s.id);var d=new google.maps.InfoWindow;d.getMap()||APmap[r].addListener("click",function(){"N/A"!==this.mun?d.setContent(this.id+"<br><center>-</center><br>"+this.mun):d.setContent(this.id),d.open(this.gmap,this)}),r++}y.getAPsIds(l)},function(e){y.APsMode=!1,ShowError(y,e,"Something went wrong while fetching Access Points.",!0),document.getElementById("APs-mode").classList.remove("quickaction-selected")})},y.getFingerPrintsTime=function(){var e={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber()};y.anyAPI.getFingerprintsTime(e).then(function(e){var t=e.data.radioPoints;t.length<=0?_err(y,"No fingerprints. Map the space using Anyplace app."):(function(e){var t=d3.format(",d");e.forEach(function(e,t){var o;e.index=t,e.date=(o=e.date,new Date(o/1e3*1e3))});var o=crossfilter(e),i=o.groupAll(),n=o.dimension(function(e){return e.date}),a=n.group(d3.time.day).reduceSum(function(e){return e.count}),r=e[0].date.toString(),l=new Date(r);l.setDate(l.getDate()-15);var s=e[e.length-1].date.toString(),d=new Date(s);d.setDate(d.getDate()+15);var c=[h().dimension(n).group(a).round(d3.time.day.round).x(d3.time.scale().domain([l,d]).rangeRound([0,1e3])).filter([l,d])],p=d3.selectAll(".chart").data(c).each(function(e){e.on("brush",g).on("brushend",g)});function u(e){d3.select(this).call(e)}function g(){p.each(u),d3.select("#active").text(t(i.value()))}function h(){h.id||(h.id=0);var s,d,o,c,i,p={top:10,right:10,bottom:20,left:10},u=d3.scale.linear().range([100,0]),g=h.id++,m=d3.svg.axis().orient("bottom"),f=d3.svg.brush();function t(e){var n=s.range()[1],a=u.range()[0];function r(e){for(var t,o=[],i=-1,n=e.length;++i<n;)t=e[i],o.push("M",s(t.key),",",a,"V",u(t.value),"h9V",a);return o.join("")}function l(e){var t=+("e"==e),o=t?1:-1,i=a/3;return"M"+.5*o+","+i+"A6,6 0 0 "+t+" "+6.5*o+","+(6+i)+"V"+(2*i-6)+"A6,6 0 0 "+t+" "+.5*o+","+2*i+"ZM"+2.5*o+","+(8+i)+"V"+(2*i-8)+"M"+4.5*o+","+(8+i)+"V"+(2*i-8)}u.domain([0,c.top(1)[0].value]),e.each(function(){var e=d3.select(this),t=e.select("g");if(t.empty()){e.select(".title").append("a").attr("href","javascript:reset("+g+")").attr("class","reset").text("reset").style("display","none"),(t=e.append("svg").attr("width",n+p.left+p.right).attr("height",a+p.top+p.bottom).append("g").attr("transform","translate("+p.left+","+p.top+")")).append("clipPath").attr("id","clip-"+g).append("rect").attr("width",n).attr("height",a),t.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(e){return e+" bar"}).datum(c.all()),t.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+g+")"),t.append("g").attr("class","axis").attr("transform","translate(0,"+a+")").call(m);var o=t.append("g").attr("class","brush").call(f);o.selectAll("rect").attr("height",a),o.selectAll(".resize").append("path").attr("d",l)}if(d)if(d=!1,t.selectAll(".brush").call(f),e.select(".title a").style("display",f.empty()?"none":null),f.empty())t.selectAll("#clip-"+g+" rect").attr("x",0).attr("width",n);else{var i=f.extent();t.selectAll("#clip-"+g+" rect").attr("x",s(i[0])).attr("width",s(i[1])-s(i[0]))}t.selectAll(".bar").attr("d",r)})}return f.on("brushstart.chart",function(){d3.select(this.parentNode.parentNode.parentNode).select(".title a").style("display",null)}),f.on("brush.chart",function(){var e=d3.select(this.parentNode),t=f.extent();i&&e.select(".brush").call(f.on("brushend",function(){v(),t=f.extent(),userTimeData=[],t.forEach(function(e){var t=String(e.getTime()/1e3*1e3);userTimeData.push(t)}),y.fingerPrintsMode&&(S(),y.showFingerprintHeatmap(),document.getElementById("fingerPrints-mode").classList.add("quickaction-selected"));y.radioHeatmapRSSMode&&(P(),y.showFingerprintCoverage(),y.radioHeatmapRSSMode=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("radioHeatmapRSSMode","YES"),y.anyService.radioHeatmapRSSMode=!0,document.getElementById("radioHeatmapRSS-mode").classList.add("quickaction-selected"))})).selectAll(".resize").style("display",null),e.select("#clip-"+g+" rect").attr("x",s(t[0])).attr("width",s(t[1])-s(t[0])),o.filterRange(t)}),f.on("brushend.chart",function(){if(f.empty()){var e=d3.select(this.parentNode.parentNode.parentNode);e.select(".title a").style("display","none"),e.select("#clip-"+g+" rect").attr("x",null).attr("width","100%"),o.filterAll()}}),t.margin=function(e){return arguments.length?(p=e,t):p},t.x=function(e){return arguments.length?(s=e,m.scale(s),f.x(s),t):s},t.y=function(e){return arguments.length?(u=e,t):u},t.dimension=function(e){return arguments.length?(o=e,t):o},t.filter=function(e){return e?(f.extent(e),o.filterRange(e)):(f.clear(),o.filterAll()),d=!0,t},t.group=function(e){return arguments.length?(c=e,t):c},t.round=function(e){return arguments.length?(i=e,t):i},d3.rebind(t,f,"on")}d3.selectAll("#total").text(t(o.size())),g(),window.filter=function(e){e.forEach(function(e,t){c[t].filter(e)}),g()},window.reset=function(e){LOG.D2("window.reset"),c[e].filter(null),g(),y.radioHeatmapRSSTimeMode&&(y.toggleCoverage(),y.toggleCoverage()),y.toggleFingerPrintsTime(),y.toggleFingerPrintsTime()}}(t),v())},function(e){console.log(ERR_FETCH_FINGERPRINTS+": timestamp.")})},y.showFingerprintHeatmap=function(){var e,t;if(P(),S(),(y.fingerPrintsTimeMode||y.radioHeatmapRSSTimeMode)&&0<userTimeData.length)if(e={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber(),timestampX:userTimeData[0],timestampY:userTimeData[1]},l!==_MAX_ZOOM_LEVEL)t=y.anyAPI.getRadioHeatmapRSSByTime_3(e);else{var o="my_custom_layer",i=new google.maps.ImageMapType({name:o,getTileUrl:function(e,t){if(l!==_MAX_ZOOM_LEVEL||!y.fingerPrintsTimeMode)return null;var o={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber(),timestampX:userTimeData[0],timestampY:userTimeData[1]};return o.x=e.x,o.y=e.y,o.z=t,y.anyAPI.getRadioHeatmapRSSByTime_Tiles(o).then(function(e){e.data;for(var t=[],o=e.data.radioPoints.length;o--;){var i=e.data.radioPoints[o];t.push({location:new google.maps.LatLng(i.x,i.y)}),e.data.radioPoints.splice(o,1)}for(o=t.length;o--;)l===_MAX_ZOOM_LEVEL&&fingerPrintsMap.push(getMapsIconFingerprint(p.gmap,t[o]));_FINGERPRINTS_IS_ON=!0},function(e){console.log(ERR_FETCH_FINGERPRINTS+": timestamp."),y.fingerPrintsMode||(document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),y.fingerPrintsMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","NO"))}),null},tileSize:new google.maps.Size(256,256),minZoom:1,maxZoom:22});p.gmap.mapTypes.set(o,i),p.gmap.setMapTypeId(o)}else if(e={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber()},l!==_MAX_ZOOM_LEVEL)t=y.anyAPI.getRadioHeatmapRSS_3(e);else{o="my_custom_layer1",i=new google.maps.ImageMapType({name:o,getTileUrl:function(e,t){if(l!==_MAX_ZOOM_LEVEL||!y.fingerPrintsMode)return null;var o={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber()};o.username=y.creds.username,o.password=y.creds.password,o.x=e.x,o.y=e.y,o.z=t,y.anyAPI.getRadioHeatmapRSS_3_Tiles(o).then(function(e){e.data;for(var t=[],o=e.data.radioPoints.length;o--;){var i=e.data.radioPoints[o];t.push({location:new google.maps.LatLng(i.x,i.y)}),e.data.radioPoints.splice(o,1)}for(o=t.length;o--;)l===_MAX_ZOOM_LEVEL&&fingerPrintsMap.push(getMapsIconFingerprint(p.gmap,t[o]));_FINGERPRINTS_IS_ON=!0},function(e){console.log(ERR_FETCH_FINGERPRINTS+": timestamp."),y.fingerPrintsMode||(document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),y.fingerPrintsMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","NO"))});return"CartoLight"===p.gmap.getMapTypeId()?"https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png".replace("{x}",e.x).replace("{y}",e.y).replace("{z}",t):"roadmap"===p.gmap.getMapTypeId()||p.gmap.getMapTypeId(),null},tileSize:new google.maps.Size(256,256),minZoom:1,maxZoom:22});localStorage.setItem("previousMapTypeId",p.gmap.getMapTypeId()),p.gmap.mapTypes.set(o,i),p.gmap.setMapTypeId(o)}void 0!==t&&t.then(function(e){e.data;var t=[],o=e.data.radioPoints.length;if(o<=0)y.fingerPrintsTimeMode?_warn_autohide(y,"No fingerprints at this period."):(_err(y,"This floor seems not to be FingerPrint mapped. Download the Anyplace app from the Google Play store to map the floor."),document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),y.fingerPrintsMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","NO"));else if(l==_MAX_ZOOM_LEVEL){for(;o--;){var i=e.data.radioPoints[o];t.push({location:new google.maps.LatLng(i.x,i.y)}),e.data.radioPoints.splice(o,1)}for(o=t.length;o--;)fingerPrintsMap.push(getMapsIconFingerprint(p.gmap,t[o]));_FINGERPRINTS_IS_ON=!0}else{for(var n=[],a=0;o--;){i=e.data.radioPoints[o],JSON.parse(i.w);n.push({location:new google.maps.LatLng(i.x,i.y),weight:1});var r=new google.maps.Marker({position:n[a].location});heatmapFingerprints.push(r),e.data.radioPoints.splice(o,1),a++}(heatmap=new google.maps.visualization.HeatmapLayer({data:n})).setMap(y.gmapService.gmap),_HEATMAP_F_IS_ON=!0}},function(e){console.log(ERR_FETCH_FINGERPRINTS+": timestamp."),y.fingerPrintsMode||(document.getElementById("fingerPrints-mode").classList.remove("quickaction-selected"),y.fingerPrintsMode=!1,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("fingerprintsMode","NO"))})},y.showLocalizationAccHeatmap=function(){var e={buid:y.anyService.getBuildingId(),floor:y.anyService.getFloorNumber()},t=$("#LAButton"),o=$("#LAButtonProgress");t.addClass("disabled"),t.prop("disabled",!0),o.removeClass("hidden"),e.username=y.creds.username,e.password=y.creds.password;y.anyAPI.getHeatmapAcces(e);_warn_autohide(y,WARN_ACCES_REMOVED)},y.showConnections=function(){for(var e in connectionsMap)if(connectionsMap.hasOwnProperty(e)){var t=connectionsMap[e];t&&t.polyLine&&t.polyLine.setMap(p.gmap)}_CONNECTIONS_IS_ON=!0,y._CONNECTIONS_IS_ON=!0,"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("connectionsMode","YES"),y.anyService.setAllConnection(connectionsMap)},p.gmap.addListener("zoom_changed",function(){if(LOG.D4("GMapService:on_zoom_changed"),(l=p.gmap.getZoom())!==_MAX_ZOOM_LEVEL){for(var e=fingerPrintsMap.length;e--;)fingerPrintsMap[e].setMap(null),fingerPrintsMap[e]=null;fingerPrintsMap=[],"my_custom_layer1"===p.gmap.getMapTypeId()&&p.gmap.setMapTypeId(localStorage.getItem("previousMapTypeId"))}if(_HEATMAP_FINGERPRINT_COVERAGE&&l!=o){for(e=heatMap.length;e--;)heatMap[e].rectangle.setMap(null),heatMap[e]=null;heatMap=[],y.showFingerprintCoverage()}if(_HEATMAP_ACCES&&(o==MIN_ZOOM_FOR_HEATMAPS&&o<l||MIN_ZOOM_FOR_HEATMAPS<o&&o<MAX_ZOOM_FOR_HEATMAPS&&(l<=MIN_ZOOM_FOR_HEATMAPS||MAX_ZOOM_FOR_HEATMAPS<=l)||o==MAX_ZOOM_FOR_HEATMAPS&&l<o)){for(e=heatMapAcces.length;e--;)heatMapAcces[e].setMap(null),heatMapAcces[e]=null;heatMapAcces=[],y.showLocalizationAccHeatmap()}if((_FINGERPRINTS_IS_ON||heatmap&&heatmap.getMap())&&!changedfloor&&l!=o){for(e=fingerPrintsMap.length;e--;)fingerPrintsMap[e].setMap(null),fingerPrintsMap[e]=null;if(fingerPrintsMap=[],heatmap&&heatmap.getMap()){heatmap.setMap(null);for(e=heatmapFingerprints.length;e--;)heatmapFingerprints[e]=null;_HEATMAP_F_IS_ON=!(heatmapFingerprints=[])}y.showFingerprintHeatmap()}o=l}),y.selectFilterForAPs=function(){switch(y.selected){case"0":y.filterByMAC=!0,y.filterByMAN=!1;break;default:y.filterByMAC=!1,y.filterByMAN=!0}},y.multiuserevents={onItemDeselect:function(e){for(i=APmap.length;i--;)if(APmap[i].id==e.id){APmap[i].setVisible(!1);break}},onItemSelect:function(e){for(i=APmap.length;i--;)if(APmap[i].id==e.id){APmap[i].setVisible(!0);break}},onDeselectAll:function(){for(i=APmap.length;i--;)APmap[i].setVisible(!1)}},y.multiuserevents1={onItemDeselect:function(e){for(i=APmap.length;i--;)if(APmap[i].mun==e.id){APmap[i].setVisible(!1);break}},onItemSelect:function(e){for(i=APmap.length;i--;)if(APmap[i].mun==e.id){APmap[i].setVisible(!0);break}},onDeselectAll:function(){for(i=APmap.length;i--;)APmap[i].setVisible(!1)}}}]);